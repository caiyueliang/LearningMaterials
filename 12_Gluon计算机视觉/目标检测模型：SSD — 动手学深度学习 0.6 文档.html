<!DOCTYPE html>
<!-- saved from url=(0051)http://zh.gluon.ai/chapter_computer-vision/ssd.html -->
<html class=" js flexbox canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths" lang="zh-CN" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>目标检测模型：SSD — 动手学深度学习 0.6 文档</title>
  

  
  
    <link rel="shortcut icon" href="http://zh.gluon.ai/_static/gluon_s2.png">
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/theme.css" type="text/css">
  <link rel="stylesheet" href="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/pygments.css" type="text/css">
  <link rel="stylesheet" href="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/gluon.css" type="text/css">
    <link rel="index" title="索引" href="http://zh.gluon.ai/genindex.html">
    <link rel="search" title="搜索" href="http://zh.gluon.ai/search.html">
    <link rel="next" title="目标检测模型：YOLO" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html">
    <link rel="prev" title="目标检测" href="http://zh.gluon.ai/chapter_computer-vision/object-detection.html"> 

  
  <script async="" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/analytics.js.下载"></script><script src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/hm.js.下载"></script><script src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/modernizr.min.js.下载"></script>

<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.1') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>

<body class="wy-body-for-nav"><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="http://zh.gluon.ai/index.html" class="icon icon-home"> 动手学深度学习
          

          
            
            <img src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/gluon_white.png" class="logo" alt="Logo">
          
          </a>

          
            
            
              <div class="version">
                0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="http://zh.gluon.ai/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_preface/index.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_crashcourse/index.html">预备知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_supervised-learning/index.html">深度学习模型基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_gluon-basics/index.html">深度学习计算基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_convolutional-neural-networks/index.html">卷积神经网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_recurrent-neural-networks/index.html">循环神经网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_optimization/index.html">优化算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_gluon-advances/index.html">计算性能</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/index.html"><span class="toctree-expand"></span>计算机视觉</a><ul class="">
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/image-augmentation.html">图片增广</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/fine-tuning.html">迁移学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/object-detection.html">目标检测</a></li>
<li class="toctree-l2 current"><a class="reference internal current" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#"><span class="toctree-expand"></span>目标检测模型：SSD</a><ul>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toctree-expand"></span>数据集</a><ul>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE">下载数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E9%9B%86">读取数据集</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%9B%BE%E7%A4%BA%E6%95%B0%E6%8D%AE">图示数据</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#SSD%E6%A8%A1%E5%9E%8B"><span class="toctree-expand"></span>SSD模型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%94%9A%E6%A1%86%EF%BC%9A%E9%BB%98%E8%AE%A4%E7%9A%84%E8%BE%B9%E7%95%8C%E6%A1%86">锚框：默认的边界框</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%A2%84%E6%B5%8B%E7%89%A9%E4%BD%93%E7%B1%BB%E5%88%AB">预测物体类别</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%A2%84%E6%B5%8B%E8%BE%B9%E7%95%8C%E6%A1%86">预测边界框</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%87%8F%E5%8D%8A%E6%A8%A1%E5%9D%97">减半模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%90%88%E5%B9%B6%E6%9D%A5%E8%87%AA%E4%B8%8D%E5%90%8C%E5%B1%82%E7%9A%84%E9%A2%84%E6%B5%8B%E8%BE%93%E5%87%BA">合并来自不同层的预测输出</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E4%B8%BB%E4%BD%93%E7%BD%91%E7%BB%9C">主体网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%8E%A9%E5%85%B7SSD%E6%A8%A1%E5%9E%8B">创建一个玩具SSD模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AE%A1%E7%AE%97%E9%A2%84%E6%B5%8B">计算预测</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%AE%8C%E6%95%B4%E7%9A%84%E6%A8%A1%E5%9E%8B">完整的模型</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AE%AD%E7%BB%83"><span class="toctree-expand"></span>训练</a><ul>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#IoU%EF%BC%9A%E4%BA%A4%E9%9B%86%E9%99%A4%E5%B9%B6%E9%9B%86">IoU：交集除并集</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0">损失函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AF%84%E4%BC%B0%E6%B5%8B%E9%87%8F">评估测量</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A8%A1%E5%9E%8B%E5%92%8C%E8%AE%AD%E7%BB%83%E5%99%A8">初始化模型和训练器</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B">训练模型</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%A2%84%E6%B5%8B">预测</a></li>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E7%BB%93%E8%AE%BA">结论</a></li>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E7%BB%83%E4%B9%A0">练习</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html">目标检测模型：YOLO</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/fcn.html">语义分割</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/neural-style.html">样式迁移</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/kaggle-gluon-cifar10.html">实战Kaggle比赛：使用Gluon对原始图像文件分类（CIFAR-10）</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/kaggle-gluon-dog.html">实战Kaggle比赛：使用Gluon识别120种狗 (ImageNet Dogs)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_natural-language-processing/index.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_appendix/index.html">附录</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="http://zh.gluon.ai/index.html">动手学深度学习</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="http://zh.gluon.ai/index.html">Docs</a> »</li>
        
          <li><a href="http://zh.gluon.ai/chapter_computer-vision/index.html">计算机视觉</a> »</li>
        
      <li>目标检测模型：SSD</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="http://zh.gluon.ai/_sources/chapter_computer-vision/ssd.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="目标检测模型：SSD">
<h1>目标检测模型：SSD<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%EF%BC%9ASSD" title="永久链接至标题">¶</a></h1>
<p>这一章下面我们将实现<a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/object-detection.html"><span class="doc">上一章</span></a>介绍的SSD来检测野生皮卡丘。</p>
<div class="figure">
<img alt="" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/pikachu.png">
</div>
<div class="section" id="数据集">
<h2>数据集<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E6%95%B0%E6%8D%AE%E9%9B%86" title="永久链接至标题">¶</a></h2>
<p>为此我们合成了一个人工数据集。我们首先使用一个开源的皮卡丘3D模型，用其生成1000张不同角度和大小的照片。然后将其随机的放在背景图片里。我们将图片打包成<code class="docutils literal"><span class="pre">rec</span></code>文件，这是一个MXNet常用的二进制数据格式。我们可以使用MXNet下的<a class="reference external" href="https://github.com/apache/incubator-mxnet/blob/master/tools/im2rec.py">tools/im2rec.py</a>来将图片打包。（TODO(@mli)
加一个教程关于如何使用im2rec）。</p>
<div class="section" id="下载数据">
<h3>下载数据<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE" title="永久链接至标题">¶</a></h3>
<p>打包好的数据可以直接在网上下载：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">gluon</span>

<span class="n">root_url</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'https://apache-mxnet.s3-accelerate.amazonaws.com/'</span>
            <span class="s1">'gluon/dataset/pikachu/'</span><span class="p">)</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">'../data/pikachu/'</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train.rec'</span><span class="p">:</span> <span class="s1">'e6bcb6ffba1ac04ff8a9b1115e650af56ee969c8'</span><span class="p">,</span>
          <span class="s1">'train.idx'</span><span class="p">:</span> <span class="s1">'dcf7318b2602c06428b9988470c731621716c393'</span><span class="p">,</span>
          <span class="s1">'val.rec'</span><span class="p">:</span> <span class="s1">'d6c33f799b4d058e82f2cb5bd9a976f69d72d520'</span><span class="p">}</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">root_url</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">sha1_hash</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="读取数据集">
<h3>读取数据集<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E9%9B%86" title="永久链接至标题">¶</a></h3>
<p>我们使用<code class="docutils literal"><span class="pre">image.ImageDetIter</span></code>来读取数据。这是针对物体检测的迭代器，(Det表示Detection)。它跟<code class="docutils literal"><span class="pre">image.ImageIter</span></code>使用很类似。主要不同是它返回的标号不是单个图片标号，而是每个图片里所有物体的标号，以及其对用的边框。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">image</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">nd</span>

<span class="n">data_shape</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">rgb_mean</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">104</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_iterators</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'pikachu'</span><span class="p">]</span>
    <span class="n">num_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ImageDetIter</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">data_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">),</span>
        <span class="n">path_imgrec</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">'train.rec'</span><span class="p">,</span>
        <span class="n">path_imgidx</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">'train.idx'</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">mean</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">rand_crop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">min_object_covered</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">max_attempts</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">val_iter</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ImageDetIter</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">data_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">),</span>
        <span class="n">path_imgrec</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">'val.rec'</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">mean</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">num_class</span>

<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">num_class</span> <span class="o">=</span> <span class="n">get_iterators</span><span class="p">(</span>
    <span class="n">data_shape</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>我们读取一个批量。可以看到标号的形状是<code class="docutils literal"><span class="pre">batch_size</span> <span class="pre">x</span> <span class="pre">num_object_per_image</span> <span class="pre">x</span> <span class="pre">5</span></code>。这里数据里每个图片里面只有一个标号。每个标号由长为5的数组表示，第一个元素是其对用物体的标号，其中<code class="docutils literal"><span class="pre">-1</span></code>表示非法物体，仅做填充使用。后面4个元素表示边框。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>DataBatch: data shapes: [(32, 3, 256, 256)] label shapes: [(32, 1, 5)]
</pre></div></div>
</div>
</div>
<div class="section" id="图示数据">
<h3>图示数据<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%9B%BE%E7%A4%BA%E6%95%B0%E6%8D%AE" title="永久链接至标题">¶</a></h3>
<p>我们画出几张图片和其对应的标号。可以看到比卡丘的角度大小位置在每张图图片都不一样。不过也注意到这个数据集是直接将二次元动漫皮卡丘跟三次元背景相结合。可能通过简单判断区域的色彩直方图就可以有效的区别是不是有我们要的物体。我们用这个简单数据集来演示SSD是如何工作的。实际中遇到的数据集通常会复杂很多。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.dpi'</span><span class="p">]</span><span class="o">=</span> <span class="mi">120</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">box_to_rect</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">"""convert an anchor box to a matplotlib rectangle"""</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
        <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">figs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">],</span> <span class="n">batch</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># (3L, 256L, 256L) =&gt; (256L, 256L, 3L)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">rgb_mean</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">/</span><span class="mi">255</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">box_to_rect</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">data_shape</span><span class="p">,</span><span class="s1">'red'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_ssd_7_0.png" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/chapter_computer-vision_ssd_7_0.png">
</div>
</div>
</div>
</div>
<div class="section" id="SSD模型">
<h2>SSD模型<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#SSD%E6%A8%A1%E5%9E%8B" title="永久链接至标题">¶</a></h2>
<div class="section" id="锚框：默认的边界框">
<h3>锚框：默认的边界框<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%94%9A%E6%A1%86%EF%BC%9A%E9%BB%98%E8%AE%A4%E7%9A%84%E8%BE%B9%E7%95%8C%E6%A1%86" title="永久链接至标题">¶</a></h3>
<p>因为边框可以出现在图片中的任何位置，并且可以有任意大小。为了简化计算，SSD跟Faster
R-CNN一样使用一些默认的边界框，或者称之为锚框（anchor
box），做为搜索起点。具体来说，对输入的每个像素，以其为中心采样数个有不同形状和不同比例的边界框。假设输入大小是
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 2.887em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.46em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.392em, 1002.46em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mi" id="MathJax-Span-3" style="font-family: MathJax_Math-italic;">w</span><span class="mo" id="MathJax-Span-4" style="font-family: MathJax_Main; padding-left: 0.216em;">×</span><span class="mi" id="MathJax-Span-5" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">h</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>w</mi><mo>×</mo><mi>h</mi></math></span></span><script type="math/tex" id="MathJax-Element-1">w \times h</script></span>，</p>
<ul class="simple">
<li>给定大小 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;&amp;#x2208;&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo stretchy=&quot;false&quot;&gt;]&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-6" style="width: 4.33em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.689em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1003.58em, 2.674em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-7"><span class="mi" id="MathJax-Span-8" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-9" style="font-family: MathJax_Main; padding-left: 0.27em;">∈</span><span class="mo" id="MathJax-Span-10" style="font-family: MathJax_Main; padding-left: 0.27em;">(</span><span class="mn" id="MathJax-Span-11" style="font-family: MathJax_Main;">0</span><span class="mo" id="MathJax-Span-12" style="font-family: MathJax_Main;">,</span><span class="mn" id="MathJax-Span-13" style="font-family: MathJax_Main; padding-left: 0.163em;">1</span><span class="mo" id="MathJax-Span-14" style="font-family: MathJax_Main;">]</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>s</mi><mo>∈</mo><mo stretchy="false">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false">]</mo></math></span></span><script type="math/tex" id="MathJax-Element-2">s\in (0,1]</script></span>，那么生成的边界框形状是
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-15" style="width: 3.956em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.368em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.392em, 1003.32em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-16"><span class="mi" id="MathJax-Span-17" style="font-family: MathJax_Math-italic;">w</span><span class="mi" id="MathJax-Span-18" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main; padding-left: 0.216em;">×</span><span class="mi" id="MathJax-Span-20" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">h</span><span class="mi" id="MathJax-Span-21" style="font-family: MathJax_Math-italic;">s</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>w</mi><mi>s</mi><mo>×</mo><mi>h</mi><mi>s</mi></math></span></span><script type="math/tex" id="MathJax-Element-3">ws \times hs</script></span></li>
<li>给定比例 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-22" style="width: 2.567em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.193em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1002.14em, 2.46em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-23"><span class="mi" id="MathJax-Span-24" style="font-family: MathJax_Math-italic;">r</span><span class="mo" id="MathJax-Span-25" style="font-family: MathJax_Main; padding-left: 0.27em;">&gt;</span><span class="mn" id="MathJax-Span-26" style="font-family: MathJax_Main; padding-left: 0.27em;">0</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>r</mi><mo>&gt;</mo><mn>0</mn></math></span></span><script type="math/tex" id="MathJax-Element-4">r > 0</script></span>，那么生成的边界框形状是
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;msqrt&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;/msqrt&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mfrac&gt;&lt;mi&gt;h&lt;/mi&gt;&lt;msqrt&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;/msqrt&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-27" style="width: 5.131em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.383em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.178em, 1004.38em, 3.048em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-28"><span class="mi" id="MathJax-Span-29" style="font-family: MathJax_Math-italic;">w</span><span class="msqrt" id="MathJax-Span-30"><span style="display: inline-block; position: relative; width: 1.285em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.43em, 4.169em, -999.997em); top: -4.004em; left: 0.857em;"><span class="mrow" id="MathJax-Span-31"><span class="mi" id="MathJax-Span-32" style="font-family: MathJax_Math-italic;">r</span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(0.964em, 1000.43em, 1.285em, -999.997em); top: -1.814em; left: 0.857em;"><span style="display: inline-block; overflow: hidden; vertical-align: -0.051em; border-top: 1.3px solid; width: 0.43em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span><span style="position: absolute; clip: rect(3.048em, 1000.86em, 4.383em, -999.997em); top: -3.95em; left: 0em;"><span style="font-family: MathJax_Main;">√</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="mo" id="MathJax-Span-33" style="font-family: MathJax_Main; padding-left: 0.216em;">×</span><span class="mfrac" id="MathJax-Span-34" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 1.018em; height: 0px; margin-right: 0.11em; margin-left: 0.11em;"><span style="position: absolute; clip: rect(3.368em, 1000.38em, 4.169em, -999.997em); top: -4.431em; left: 50%; margin-left: -0.211em;"><span class="mi" id="MathJax-Span-35" style="font-size: 70.7%; font-family: MathJax_Math-italic;">h</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(3.368em, 1000.91em, 4.383em, -999.997em); top: -3.576em; left: 50%; margin-left: -0.425em;"><span class="msqrt" id="MathJax-Span-36"><span style="display: inline-block; position: relative; width: 0.911em; height: 0px;"><span style="position: absolute; clip: rect(3.528em, 1000.32em, 4.169em, -999.997em); top: -4.004em; left: 0.59em;"><span class="mrow" id="MathJax-Span-37"><span class="mi" id="MathJax-Span-38" style="font-size: 70.7%; font-family: MathJax_Math-italic;">r</span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(0.964em, 1000.32em, 1.285em, -999.997em); top: -1.6em; left: 0.59em;"><span style="display: inline-block; overflow: hidden; vertical-align: -0.051em; border-top: 1.3px solid; width: 0.323em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span><span style="position: absolute; clip: rect(3.261em, 1000.59em, 4.33em, -999.997em); top: -3.95em; left: 0em;"><span><span style="font-size: 70.7%; font-family: MathJax_Main;">√</span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(0.857em, 1001.02em, 1.231em, -999.997em); top: -1.279em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 1.018em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.809em; border-left: 0px solid; width: 0px; height: 1.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>w</mi><msqrt><mi>r</mi></msqrt><mo>×</mo><mfrac><mi>h</mi><msqrt><mi>r</mi></msqrt></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-5">w\sqrt{r} \times \frac{h}{\sqrt{r}}</script></span></li>
</ul>
<p>在采样的时候我们提供 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-39" style="width: 0.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.59em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.59em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-40"><span class="mi" id="MathJax-Span-41" style="font-family: MathJax_Math-italic;">n</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-6">n</script></span> 个大小（<code class="docutils literal"><span class="pre">sizes</span></code>）和 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-42" style="width: 1.071em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.911em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.91em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-43"><span class="mi" id="MathJax-Span-44" style="font-family: MathJax_Math-italic;">m</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi></math></span></span><script type="math/tex" id="MathJax-Element-7">m</script></span>
个比例（<code class="docutils literal"><span class="pre">ratios</span></code>）。为了计算简单这里不生成<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-8-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-45" style="width: 1.765em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.498em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1001.5em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-46"><span class="mi" id="MathJax-Span-47" style="font-family: MathJax_Math-italic;">n</span><span class="mi" id="MathJax-Span-48" style="font-family: MathJax_Math-italic;">m</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mi>m</mi></math></span></span><script type="math/tex" id="MathJax-Element-8">nm</script></span>个锚框，而是<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-9-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-49" style="width: 5.077em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.33em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1004.28em, 2.513em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-50"><span class="mi" id="MathJax-Span-51" style="font-family: MathJax_Math-italic;">n</span><span class="mo" id="MathJax-Span-52" style="font-family: MathJax_Main; padding-left: 0.216em;">+</span><span class="mi" id="MathJax-Span-53" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">m</span><span class="mo" id="MathJax-Span-54" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="mn" id="MathJax-Span-55" style="font-family: MathJax_Main; padding-left: 0.216em;">1</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.184em; border-left: 0px solid; width: 0px; height: 1.003em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mo>+</mo><mi>m</mi><mo>−</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-9">n+m-1</script></span>个。其中第
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-10-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-56" style="width: 0.43em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.377em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1000.32em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-57"><span class="mi" id="MathJax-Span-58" style="font-family: MathJax_Math-italic;">i</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>i</mi></math></span></span><script type="math/tex" id="MathJax-Element-10">i</script></span> 个锚框使用</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">sizes[i]</span></code>和<code class="docutils literal"><span class="pre">ratios[0]</span></code> 如果 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-11-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;&amp;#x2264;&lt;/mo&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-59" style="width: 2.567em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.193em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1002.19em, 2.567em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-60"><span class="mi" id="MathJax-Span-61" style="font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-62" style="font-family: MathJax_Main; padding-left: 0.27em;">≤</span><span class="mi" id="MathJax-Span-63" style="font-family: MathJax_Math-italic; padding-left: 0.27em;">n</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>i</mi><mo>≤</mo><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-11">i\le n</script></span></li>
<li><code class="docutils literal"><span class="pre">sizes[0]</span></code>和<code class="docutils literal"><span class="pre">ratios[i-n]</span></code> 如果 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-12-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;&amp;gt;&lt;/mo&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-64" style="width: 2.567em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.193em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1002.19em, 2.46em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-65"><span class="mi" id="MathJax-Span-66" style="font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-67" style="font-family: MathJax_Main; padding-left: 0.27em;">&gt;</span><span class="mi" id="MathJax-Span-68" style="font-family: MathJax_Math-italic; padding-left: 0.27em;">n</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.122em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>i</mi><mo>&gt;</mo><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-12">i>n</script></span></li>
</ul>
<p>我们可以使用<code class="docutils literal"><span class="pre">contribe.ndarray</span></code>里的<code class="docutils literal"><span class="pre">MultiBoxPrior</span></code>来采样锚框。这里锚框通过左下角和右上角两个点来确定，而且被标准化成了区间<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-13-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;[&lt;/mo&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo stretchy=&quot;false&quot;&gt;]&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-69" style="width: 2.353em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.979em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1001.87em, 2.674em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-70"><span class="mo" id="MathJax-Span-71" style="font-family: MathJax_Main;">[</span><span class="mn" id="MathJax-Span-72" style="font-family: MathJax_Main;">0</span><span class="mo" id="MathJax-Span-73" style="font-family: MathJax_Main;">,</span><span class="mn" id="MathJax-Span-74" style="font-family: MathJax_Main; padding-left: 0.163em;">1</span><span class="mo" id="MathJax-Span-75" style="font-family: MathJax_Main;">]</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="false">]</mo></math></span></span><script type="math/tex" id="MathJax-Element-13">[0,1]</script></span>的实数。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">nd</span>
<span class="kn">from</span> <span class="nn">mxnet.contrib.ndarray</span> <span class="kn">import</span> <span class="n">MultiBoxPrior</span>

<span class="c1"># shape: batch x channel x height x weight</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">MultiBoxPrior</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="n">ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">])</span>

<span class="n">boxes</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># The first anchor box centered on (20, 20)</span>
<span class="c1"># its format is (x_min, y_min, x_max, y_max)</span>
<span class="n">boxes</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>(40, 40, 5, 4)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[5]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>[ 0.26249999  0.26249999  0.76249999  0.76249999]
&lt;NDArray 4 @cpu(0)&gt;
</pre></div>
</div>
</div>
<p>我们可以画出以<code class="docutils literal"><span class="pre">(20,20)</span></code>为中心的所有锚框：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'blue'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'magenta'</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
<span class="n">anchors</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">box_to_rect</span><span class="p">(</span><span class="n">anchors</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_ssd_11_0.png" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/chapter_computer-vision_ssd_11_0.png">
</div>
</div>
</div>
<div class="section" id="预测物体类别">
<h3>预测物体类别<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%A2%84%E6%B5%8B%E7%89%A9%E4%BD%93%E7%B1%BB%E5%88%AB" title="永久链接至标题">¶</a></h3>
<p>对每一个锚框我们需要预测它是不是包含了我们感兴趣的物体，还是只是背景。这里我们使用一个<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-14-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-76" style="width: 2.513em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.139em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1002.09em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-77"><span class="mn" id="MathJax-Span-78" style="font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-79" style="font-family: MathJax_Main; padding-left: 0.216em;">×</span><span class="mn" id="MathJax-Span-80" style="font-family: MathJax_Main; padding-left: 0.216em;">3</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mo>×</mo><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-14">3\times 3</script></span>的卷积层来做预测，加上<code class="docutils literal"><span class="pre">pad=1</span></code>使用它的输出和输入一样。同时输出的通道数是<code class="docutils literal"><span class="pre">num_anchors*(num_classes+1)</span></code>，每个通道对应一个锚框对某个类的置信度。假设输出是<code class="docutils literal"><span class="pre">Y</span></code>，那么对应输入中第<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-15-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-81" style="width: 0.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.59em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.59em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-82"><span class="mi" id="MathJax-Span-83" style="font-family: MathJax_Math-italic;">n</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-15">n</script></span>个样本的第<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-16-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-84" style="width: 2.353em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.979em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1001.87em, 2.674em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-85"><span class="mo" id="MathJax-Span-86" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-87" style="font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-88" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-89" style="font-family: MathJax_Math-italic; padding-left: 0.163em;">j</span><span class="mo" id="MathJax-Span-90" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-16">(i,j)</script></span>像素的置信值是在<code class="docutils literal"><span class="pre">Y[n,:,i,j]</span></code>里。具体来说，对于以<code class="docutils literal"><span class="pre">(i,j)</span></code>为中心的第<code class="docutils literal"><span class="pre">a</span></code>个锚框，</p>
<ul class="simple">
<li>通道 <code class="docutils literal"><span class="pre">a*(num_class+1)</span></code> 是其只包含背景的分数</li>
<li>通道 <code class="docutils literal"><span class="pre">a*(num_class+1)+1+b</span></code> 是其包含第<code class="docutils literal"><span class="pre">b</span></code>个物体的分数</li>
</ul>
<p>我们定义个一个这样的类别分类器函数：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet.gluon</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="k">def</span> <span class="nf">class_predictor</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="sd">"""return a layer to predict classes"""</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">num_anchors</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">cls_pred</span> <span class="o">=</span> <span class="n">class_predictor</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">cls_pred</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cls_pred</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[7]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>(2, 55, 20, 20)
</pre></div>
</div>
</div>
</div>
<div class="section" id="预测边界框">
<h3>预测边界框<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%A2%84%E6%B5%8B%E8%BE%B9%E7%95%8C%E6%A1%86" title="永久链接至标题">¶</a></h3>
<p>因为真实的边界框可以是任意形状，我们需要预测如何从一个锚框变换成真正的边界框。这个变换可以由一个长为4的向量来描述。同上一样，我们用一个有<code class="docutils literal"><span class="pre">num_anchors</span> <span class="pre">*</span> <span class="pre">4</span></code>通道的卷积。假设输出是Y，那么对应输入中第
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-17-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-91" style="width: 0.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.59em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.59em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-92"><span class="mi" id="MathJax-Span-93" style="font-family: MathJax_Math-italic;">n</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-17">n</script></span> 个样本的第 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-18-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-94" style="width: 2.353em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.979em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1001.87em, 2.674em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-95"><span class="mo" id="MathJax-Span-96" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-97" style="font-family: MathJax_Math-italic;">i</span><span class="mo" id="MathJax-Span-98" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-99" style="font-family: MathJax_Math-italic; padding-left: 0.163em;">j</span><span class="mo" id="MathJax-Span-100" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-18">(i,j)</script></span>
像素为中心的锚框的转换在<code class="docutils literal"><span class="pre">Y[n,:,i,j]</span></code>里。具体来说，对于第<code class="docutils literal"><span class="pre">a</span></code>个锚框，它的变换在<code class="docutils literal"><span class="pre">a*4</span></code>到<code class="docutils literal"><span class="pre">a*4+3</span></code>通道里。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">box_predictor</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">):</span>
    <span class="sd">"""return a layer to predict delta locations"""</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">num_anchors</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">box_pred</span> <span class="o">=</span> <span class="n">box_predictor</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">box_pred</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">box_pred</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[8]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>(2, 40, 20, 20)
</pre></div>
</div>
</div>
</div>
<div class="section" id="减半模块">
<h3>减半模块<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%87%8F%E5%8D%8A%E6%A8%A1%E5%9D%97" title="永久链接至标题">¶</a></h3>
<p>我们定义一个卷积块，它将输入特征的长宽减半，以此来获取多尺度的预测。它由两个<code class="docutils literal"><span class="pre">Conv-BatchNorm-Relu</span></code>组成，我们使用填充为1的<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-19-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-101" style="width: 2.513em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.139em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1002.09em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-102"><span class="mn" id="MathJax-Span-103" style="font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-104" style="font-family: MathJax_Main; padding-left: 0.216em;">×</span><span class="mn" id="MathJax-Span-105" style="font-family: MathJax_Main; padding-left: 0.216em;">3</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mo>×</mo><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-19">3\times 3</script></span>卷积使得输入和输入有同样的长宽，然后再通过跨度为2的最大池化层将长宽减半。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">down_sample</span><span class="p">(</span><span class="n">num_filters</span><span class="p">):</span>
    <span class="sd">"""stack two Conv-BatchNorm-Relu blocks and then a pooling layer</span>
<span class="sd">    to halve the feature size"""</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">num_filters</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">num_filters</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">blk</span> <span class="o">=</span> <span class="n">down_sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">blk</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">blk</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[9]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>(2, 10, 10, 10)
</pre></div>
</div>
</div>
</div>
<div class="section" id="合并来自不同层的预测输出">
<h3>合并来自不同层的预测输出<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%90%88%E5%B9%B6%E6%9D%A5%E8%87%AA%E4%B8%8D%E5%90%8C%E5%B1%82%E7%9A%84%E9%A2%84%E6%B5%8B%E8%BE%93%E5%87%BA" title="永久链接至标题">¶</a></h3>
<p>前面我们提到过SSD的一个重要性质是它会在多个层同时做预测。每个层由于长宽和锚框选择不一样，导致输出的数据形状会不一样。这里我们用物体类别预测作为样例，边框预测是类似的。</p>
<p>我们首先创建一个特定大小的输入，然后对它输出类别预测。然后对输入减半，再输出类别预测。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'x:'</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">cls_pred1</span> <span class="o">=</span> <span class="n">class_predictor</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">cls_pred1</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">cls_pred1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Class prediction 1:'</span><span class="p">,</span> <span class="n">y1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">down_sample</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'x:'</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">cls_pred2</span> <span class="o">=</span> <span class="n">class_predictor</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">cls_pred2</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">cls_pred2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Class prediction 2:'</span><span class="p">,</span> <span class="n">y2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>x: (2, 8, 20, 20)
Class prediction 1: (2, 55, 20, 20)
x: (2, 16, 10, 10)
Class prediction 2: (2, 33, 10, 10)
</pre></div></div>
</div>
<p>可以看到<code class="docutils literal"><span class="pre">y1</span></code>和<code class="docutils literal"><span class="pre">y2</span></code>形状不同。为了之后处理简单，我们将不同层的输入合并成一个输出。首先我们将通道移到最后的维度，然后将其展成2D数组。因为第一个维度是样本个数，所以不同输出之间是不变，我们可以将所有输出在第二个维度上拼接起来。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flatten_prediction</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pred</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">concat_predictions</span><span class="p">(</span><span class="n">preds</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="n">preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">flat_y1</span> <span class="o">=</span> <span class="n">flatten_prediction</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Flatten class prediction 1'</span><span class="p">,</span> <span class="n">flat_y1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">flat_y2</span> <span class="o">=</span> <span class="n">flatten_prediction</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Flatten class prediction 2'</span><span class="p">,</span> <span class="n">flat_y2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">concat_predictions</span><span class="p">([</span><span class="n">flat_y1</span><span class="p">,</span> <span class="n">flat_y2</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Concat class predictions'</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>Flatten class prediction 1 (2, 22000)
Flatten class prediction 2 (2, 3300)
Concat class predictions (2, 25300)
</pre></div></div>
</div>
</div>
<div class="section" id="主体网络">
<h3>主体网络<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E4%B8%BB%E4%BD%93%E7%BD%91%E7%BB%9C" title="永久链接至标题">¶</a></h3>
<p>主体网络用来从原始像素抽取特征。通常前面介绍的用来图片分类的卷积神经网络，例如ResNet，都可以用来作为主体网络。这里为了示范，我们简单叠加几个减半模块作为主体网络。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">body</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">nfilters</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">down_sample</span><span class="p">(</span><span class="n">nfilters</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="n">bnet</span> <span class="o">=</span> <span class="n">body</span><span class="p">()</span>
<span class="n">bnet</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">bnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[12]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>(2, 64, 32, 32)
</pre></div>
</div>
</div>
</div>
<div class="section" id="创建一个玩具SSD模型">
<h3>创建一个玩具SSD模型<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%8E%A9%E5%85%B7SSD%E6%A8%A1%E5%9E%8B" title="永久链接至标题">¶</a></h3>
<p>现在我们可以创建一个玩具SSD模型了。我们称之为玩具是因为这个网络不管是层数还是锚框个数都比较小，仅仅适合之后我们之后使用的一个小数据集。但这个模型不会影响我们介绍SSD。</p>
<p>这个网络包含四块。主体网络，三个减半模块，以及五个物体类别和边框预测模块。其中预测分别应用在在主体网络输出，减半模块输出，和最后的全局池化层上。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">toy_ssd_model</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="n">downsamplers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">downsamplers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">down_sample</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>

    <span class="n">class_predictors</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">box_predictors</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">class_predictors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_predictor</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">))</span>
        <span class="n">box_predictors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">box_predictor</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">))</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">body</span><span class="p">(),</span> <span class="n">downsamplers</span><span class="p">,</span> <span class="n">class_predictors</span><span class="p">,</span> <span class="n">box_predictors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="计算预测">
<h3>计算预测<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AE%A1%E7%AE%97%E9%A2%84%E6%B5%8B" title="永久链接至标题">¶</a></h3>
<p>给定模型和每层预测输出使用的锚框大小和形状，我们可以定义前向函数。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">toy_ssd_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">ratios</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">body</span><span class="p">,</span> <span class="n">downsamplers</span><span class="p">,</span> <span class="n">class_predictors</span><span class="p">,</span> <span class="n">box_predictors</span> <span class="o">=</span> <span class="n">model</span>
    <span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">box_preds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="c1"># feature extraction</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">body</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># predict</span>
        <span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MultiBoxPrior</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ratios</span><span class="o">=</span><span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">class_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">flatten_prediction</span><span class="p">(</span><span class="n">class_predictors</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">box_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">flatten_prediction</span><span class="p">(</span><span class="n">box_predictors</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'Predict scale'</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">'with'</span><span class="p">,</span>
                  <span class="n">anchors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'anchors'</span><span class="p">)</span>
        <span class="c1"># down sample</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">downsamplers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Pooling</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">global_pool</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">'max'</span><span class="p">,</span>
                <span class="n">kernel</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="c1"># concat data</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">concat_predictions</span><span class="p">(</span><span class="n">anchors</span><span class="p">),</span>
            <span class="n">concat_predictions</span><span class="p">(</span><span class="n">class_preds</span><span class="p">),</span>
            <span class="n">concat_predictions</span><span class="p">(</span><span class="n">box_preds</span><span class="p">))</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="完整的模型">
<h3>完整的模型<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%AE%8C%E6%95%B4%E7%9A%84%E6%A8%A1%E5%9E%8B" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">gluon</span>
<span class="k">class</span> <span class="nc">ToySSD</span><span class="p">(</span><span class="n">gluon</span><span class="o">.</span><span class="n">Block</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ToySSD</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># anchor box sizes and ratios for 5 feature scales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span> <span class="o">=</span> <span class="p">[[</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">272</span><span class="p">],</span> <span class="p">[</span><span class="o">.</span><span class="mi">37</span><span class="p">,</span><span class="o">.</span><span class="mi">447</span><span class="p">],</span> <span class="p">[</span><span class="o">.</span><span class="mi">54</span><span class="p">,</span><span class="o">.</span><span class="mi">619</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">.</span><span class="mi">71</span><span class="p">,</span><span class="o">.</span><span class="mi">79</span><span class="p">],</span> <span class="p">[</span><span class="o">.</span><span class="mi">88</span><span class="p">,</span><span class="o">.</span><span class="mi">961</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratios</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">]]</span><span class="o">*</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="n">num_anchors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># use name_scope to guard the names</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">toy_ssd_model</span><span class="p">(</span><span class="n">num_anchors</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">box_preds</span> <span class="o">=</span> <span class="n">toy_ssd_forward</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratios</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># it is better to have class predictions reshaped for softmax computation</span>
        <span class="n">class_preds</span> <span class="o">=</span> <span class="n">class_preds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">box_preds</span>
</pre></div>
</div>
</div>
<p>我们看一下输入图片的形状是如何改变的，已经输出的形状。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">ToySSD</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Input:'</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">box_preds</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Output achors:'</span><span class="p">,</span> <span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Output class predictions:'</span><span class="p">,</span> <span class="n">class_preds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'Output box predictions:'</span><span class="p">,</span> <span class="n">box_preds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>Input: (1, 3, 256, 256)
Predict scale 0 (1, 64, 32, 32) with 4096 anchors
Predict scale 1 (1, 128, 16, 16) with 1024 anchors
Predict scale 2 (1, 128, 8, 8) with 256 anchors
Predict scale 3 (1, 128, 4, 4) with 64 anchors
Predict scale 4 (1, 128, 1, 1) with 4 anchors
Output achors: (1, 5444, 4)
Output class predictions: (1, 5444, 3)
Output box predictions: (1, 21776)
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="训练">
<h2>训练<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AE%AD%E7%BB%83" title="永久链接至标题">¶</a></h2>
<p>之前的教程我们主要是关注分类。对于分类的预测结果和真实的标号，我们通过交叉熵来计算他们的差异。但物体检测里我们需要预测边框。这里我们先引入一个概率来描述两个边框的距离。</p>
<div class="section" id="IoU：交集除并集">
<h3>IoU：交集除并集<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#IoU%EF%BC%9A%E4%BA%A4%E9%9B%86%E9%99%A4%E5%B9%B6%E9%9B%86" title="永久链接至标题">¶</a></h3>
<p>我们知道判断两个集合的相似度最常用的衡量叫做Jaccard距离，给定集合
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-20-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-106" style="width: 0.911em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.751em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.392em, 1000.75em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-107"><span class="mi" id="MathJax-Span-108" style="font-family: MathJax_Math-italic;">A</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi></math></span></span><script type="math/tex" id="MathJax-Element-20">A</script></span> 和 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-21-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-109" style="width: 0.964em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.804em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.392em, 1000.8em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-110"><span class="mi" id="MathJax-Span-111" style="font-family: MathJax_Math-italic;">B</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-21">B</script></span>，它的定义是</p>
<div class="math">
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-22-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;J&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo&gt;&amp;#x2229;&lt;/mo&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;mo&gt;&amp;#x222A;&lt;/mo&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-112" style="width: 9.458em; display: inline-block;"><span style="display: inline-block; position: relative; width: 8.069em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.59em, 1008.07em, 3.368em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-113"><span class="mi" id="MathJax-Span-114" style="font-family: MathJax_Math-italic;">J<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.056em;"></span></span><span class="mo" id="MathJax-Span-115" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-116" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-117" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-118" style="font-family: MathJax_Math-italic; padding-left: 0.163em;">B</span><span class="mo" id="MathJax-Span-119" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-120" style="font-family: MathJax_Main; padding-left: 0.27em;">=</span><span class="mfrac" id="MathJax-Span-121" style="padding-left: 0.27em;"><span style="display: inline-block; position: relative; width: 3.261em; height: 0px; margin-right: 0.11em; margin-left: 0.11em;"><span style="position: absolute; clip: rect(3.101em, 1003.05em, 4.436em, -999.997em); top: -4.752em; left: 50%; margin-left: -1.6em;"><span class="mrow" id="MathJax-Span-122"><span class="texatom" id="MathJax-Span-123"><span class="mrow" id="MathJax-Span-124"><span class="mo" id="MathJax-Span-125" style="font-family: MathJax_Main;">|</span></span></span><span class="mi" id="MathJax-Span-126" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-127" style="font-family: MathJax_Main; padding-left: 0.216em;">∩</span><span class="mi" id="MathJax-Span-128" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">B</span><span class="texatom" id="MathJax-Span-129"><span class="mrow" id="MathJax-Span-130"><span class="mo" id="MathJax-Span-131" style="font-family: MathJax_Main;">|</span></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(3.101em, 1003.05em, 4.436em, -999.997em); top: -3.256em; left: 50%; margin-left: -1.6em;"><span class="mrow" id="MathJax-Span-132"><span class="texatom" id="MathJax-Span-133"><span class="mrow" id="MathJax-Span-134"><span class="mo" id="MathJax-Span-135" style="font-family: MathJax_Main;">|</span></span></span><span class="mi" id="MathJax-Span-136" style="font-family: MathJax_Math-italic;">A</span><span class="mo" id="MathJax-Span-137" style="font-family: MathJax_Main; padding-left: 0.216em;">∪</span><span class="mi" id="MathJax-Span-138" style="font-family: MathJax_Math-italic; padding-left: 0.216em;">B</span><span class="texatom" id="MathJax-Span-139"><span class="mrow" id="MathJax-Span-140"><span class="mo" id="MathJax-Span-141" style="font-family: MathJax_Main;">|</span></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(0.857em, 1003.26em, 1.231em, -999.997em); top: -1.279em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 3.261em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.071em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.184em; border-left: 0px solid; width: 0px; height: 3.003em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>J</mi><mo stretchy="false">(</mo><mi>A</mi><mo>,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>A</mi><mo>∩</mo><mi>B</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></mrow><mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>A</mi><mo>∪</mo><mi>B</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></mrow></mfrac></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-22">J(A,B) = \frac{|A\cap B|}{| A \cup B|}</script></div>
<p>边框可以看成是像素的集合，我们可以类似的定义它。这个标准通常被称之为
Intersection over Union (IoU)。</p>
<div class="figure">
<img alt="" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/iou.svg"></div>
<p>大的值表示两个边框很相似，而小的值则表示不相似。</p>
</div>
<div class="section" id="损失函数">
<h3>损失函数<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0" title="永久链接至标题">¶</a></h3>
<p>虽然每张图片里面通常只有几个标注的边框，但SSD会生成大量的锚框。可以想象很多锚框都不会框住感兴趣的物体，就是说跟任何对应感兴趣物体的表框的IoU都小于某个阈值。这样就会产生大量的负类锚框，或者说对应标号为0的锚框。对于这类锚框有两点要考虑的：</p>
<ol class="arabic simple">
<li>边框预测的损失函数不应该包括负类锚框，因为它们并没有对应的真实边框</li>
<li>因为负类锚框数目可能远多于其他，我们可以只保留其中的一些。而且是保留那些目前预测最不确信它是负类的，就是对类0预测值排序，选取数值最小的哪一些困难的负类锚框。</li>
</ol>
<p>我们可以使用<code class="docutils literal"><span class="pre">MultiBoxTarget</span></code>来完成上面这两个操作。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet.contrib.ndarray</span> <span class="kn">import</span> <span class="n">MultiBoxTarget</span>
<span class="k">def</span> <span class="nf">training_targets</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">class_preds</span> <span class="o">=</span> <span class="n">class_preds</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">MultiBoxTarget</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">training_targets</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[17]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>[
 [[ 0.  0.  0. ...,  0.  0.  0.]]
 &lt;NDArray 1x21776 @cpu(0)&gt;,
 [[ 0.  0.  0. ...,  0.  0.  0.]]
 &lt;NDArray 1x21776 @cpu(0)&gt;,
 [[ 0.  0.  0. ...,  0.  0.  0.]]
 &lt;NDArray 1x5444 @cpu(0)&gt;]
</pre></div>
</div>
</div>
<p>它返回三个<code class="docutils literal"><span class="pre">NDArray</span></code>，分别是</p>
<ol class="arabic simple">
<li>预测的边框跟真实边框的偏移，大小是<code class="docutils literal"><span class="pre">batch_size</span> <span class="pre">x</span> <span class="pre">(num_anchors*4)</span></code></li>
<li>用来遮掩不需要的负类锚框的掩码，大小跟上面一致</li>
<li>锚框的真实的标号，大小是<code class="docutils literal"><span class="pre">batch_size</span> <span class="pre">x</span> <span class="pre">num_anchors</span></code></li>
</ol>
<p>我们可以计算这次只选中了多少个锚框进入损失函数：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[18]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>[ 9.]
&lt;NDArray 1 @cpu(0)&gt;
</pre></div>
</div>
</div>
<p>然后我们可以定义需要的损失函数了。</p>
<p>对于分类问题，最常用的损失函数是之前一直使用的交叉熵。这里我们定义一个类似于交叉熵的损失，不同于交叉熵的定义
<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-23-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;log&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-142" style="width: 3.475em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.941em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1002.83em, 2.727em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-143"><span class="mi" id="MathJax-Span-144" style="font-family: MathJax_Main;">log</span><span class="mo" id="MathJax-Span-145"></span><span class="mo" id="MathJax-Span-146" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-147"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.48em, 4.383em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-148" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -3.843em; left: 0.483em;"><span class="mi" id="MathJax-Span-149" style="font-size: 70.7%; font-family: MathJax_Math-italic;">j</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="mo" id="MathJax-Span-150" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mi>j</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-23">\log(p_j)</script></span>，这里 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-24-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-151" style="width: 0.537em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.43em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.445em, 1000.43em, 2.62em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-152"><span class="mi" id="MathJax-Span-153" style="font-family: MathJax_Math-italic;">j</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>j</mi></math></span></span><script type="math/tex" id="MathJax-Element-24">j</script></span> 是真实的类别，且 <span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-25-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-154" style="width: 1.018em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.605em, 1000.86em, 2.674em, -999.997em); top: -2.188em; left: 0em;"><span class="mrow" id="MathJax-Span-155"><span class="msubsup" id="MathJax-Span-156"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.48em, 4.383em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-157" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -3.843em; left: 0.483em;"><span class="mi" id="MathJax-Span-158" style="font-size: 70.7%; font-family: MathJax_Math-italic;">j</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.193em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.003em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>p</mi><mi>j</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-25">p_j</script></span>
是对于的预测概率。我们使用一个被称之为关注损失的函数，给定正的<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-26-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-159" style="width: 0.59em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.483em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.48em, 2.62em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-160"><span class="mi" id="MathJax-Span-161" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>γ</mi></math></span></span><script type="math/tex" id="MathJax-Element-26">\gamma</script></span>和<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-27-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B1;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-162" style="width: 0.751em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.644em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.59em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-163"><span class="mi" id="MathJax-Span-164" style="font-family: MathJax_Math-italic;">α</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>α</mi></math></span></span><script type="math/tex" id="MathJax-Element-27">\alpha</script></span>，它的定义是</p>
<div class="math">
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-28-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B1;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;msup&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;mi&gt;log&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-165" style="width: 9.618em; display: inline-block;"><span style="display: inline-block; position: relative; width: 8.229em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1008.12em, 2.727em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-166"><span class="mo" id="MathJax-Span-167" style="font-family: MathJax_Main;">−</span><span class="mi" id="MathJax-Span-168" style="font-family: MathJax_Math-italic;">α</span><span class="mo" id="MathJax-Span-169" style="font-family: MathJax_Main;">(</span><span class="mn" id="MathJax-Span-170" style="font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-171" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="msubsup" id="MathJax-Span-172" style="padding-left: 0.216em;"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.48em, 4.383em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-173" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -3.843em; left: 0.483em;"><span class="mi" id="MathJax-Span-174" style="font-size: 70.7%; font-family: MathJax_Math-italic;">j</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-175"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.101em, 1000.32em, 4.436em, -999.997em); top: -4.004em; left: 0em;"><span class="mo" id="MathJax-Span-176" style="font-family: MathJax_Main;">)</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -4.431em; left: 0.377em;"><span class="texatom" id="MathJax-Span-177"><span class="mrow" id="MathJax-Span-178"><span class="mi" id="MathJax-Span-179" style="font-size: 70.7%; font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="mi" id="MathJax-Span-180" style="font-family: MathJax_Main; padding-left: 0.163em;">log</span><span class="mo" id="MathJax-Span-181"></span><span class="mo" id="MathJax-Span-182" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-183"><span style="display: inline-block; position: relative; width: 0.857em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.48em, 4.383em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-184" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -3.843em; left: 0.483em;"><span class="mi" id="MathJax-Span-185" style="font-size: 70.7%; font-family: MathJax_Math-italic;">j</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="mo" id="MathJax-Span-186" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.378em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mo>−</mo><mi>α</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>j</mi></msub><msup><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mi>γ</mi></mrow></msup><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mi>j</mi></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-28">- \alpha (1-p_j)^{\gamma} \log(p_j)</script></div>
<p>下图我们演示不同<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-29-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-187" style="width: 0.59em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.483em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.48em, 2.62em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-188"><span class="mi" id="MathJax-Span-189" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>γ</mi></math></span></span><script type="math/tex" id="MathJax-Element-29">\gamma</script></span>导致的变化。可以看到，增加<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-30-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B3;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-190" style="width: 0.59em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.483em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.48em, 2.62em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-191"><span class="mi" id="MathJax-Span-192" style="font-family: MathJax_Math-italic;">γ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>γ</mi></math></span></span><script type="math/tex" id="MathJax-Element-30">\gamma</script></span>可以使得对正类预测值比较大时损失变小。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">focal_loss</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="n">gamma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mo">01</span><span class="p">)</span>
<span class="n">gammas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gammas</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">focal_loss</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">'gamma='</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gammas</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_ssd_37_0.png" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/chapter_computer-vision_ssd_37_0.png">
</div>
</div>
<p>这个自定义的损失函数可以简单通过继承<code class="docutils literal"><span class="pre">gluon.loss.Loss</span></code>来实现。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FocalLoss</span><span class="p">(</span><span class="n">gluon</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">Loss</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FocalLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="o">=</span> <span class="n">axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span> <span class="o">=</span> <span class="n">gamma</span>

    <span class="k">def</span> <span class="nf">hybrid_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">pj</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">pick</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pj</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">pj</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_axis</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">cls_loss</span> <span class="o">=</span> <span class="n">FocalLoss</span><span class="p">()</span>
<span class="n">cls_loss</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[20]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>FocalLoss(batch_axis=0, w=None)
</pre></div>
</div>
</div>
<p>对于边框的预测是一个回归问题。通常可以选择平方损失函数（L2损失）<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-31-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-193" style="width: 4.917em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.169em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.231em, 1004.17em, 2.674em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-194"><span class="mi" id="MathJax-Span-195" style="font-family: MathJax_Math-italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.056em;"></span></span><span class="mo" id="MathJax-Span-196" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-197" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-198" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-199" style="font-family: MathJax_Main; padding-left: 0.27em;">=</span><span class="msubsup" id="MathJax-Span-200" style="padding-left: 0.27em;"><span style="display: inline-block; position: relative; width: 1.018em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.54em, 4.169em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-201" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -4.378em; left: 0.59em;"><span class="mn" id="MathJax-Span-202" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.378em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>x</mi><mn>2</mn></msup></math></span></span><script type="math/tex" id="MathJax-Element-31">f(x)=x^2</script></span>。但这个损失对于比较大的误差的惩罚很高。我们可以采用稍微缓和一点绝对损失函数（L1损失）<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-32-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-203" style="width: 5.024em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.276em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.338em, 1004.17em, 2.674em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-204"><span class="mi" id="MathJax-Span-205" style="font-family: MathJax_Math-italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.056em;"></span></span><span class="mo" id="MathJax-Span-206" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-207" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-208" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-209" style="font-family: MathJax_Main; padding-left: 0.27em;">=</span><span class="texatom" id="MathJax-Span-210" style="padding-left: 0.27em;"><span class="mrow" id="MathJax-Span-211"><span class="mo" id="MathJax-Span-212" style="font-family: MathJax_Main;">|</span></span></span><span class="mi" id="MathJax-Span-213" style="font-family: MathJax_Math-italic;">x</span><span class="texatom" id="MathJax-Span-214"><span class="mrow" id="MathJax-Span-215"><span class="mo" id="MathJax-Span-216" style="font-family: MathJax_Main;">|</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-32">f(x)=|x|</script></span>，它是随着误差线性增长，而不是平方增长。但这个函数在0点处导数不唯一，因此可能会影响收敛。一个通常的解决办法是在0点附近使用平方函数使得它更加平滑。它被称之为平滑L1损失函数。它通过一个参数<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-33-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-217" style="width: 0.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.59em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.59em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-218"><span class="mi" id="MathJax-Span-219" style="font-family: MathJax_Math-italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>σ</mi></math></span></span><script type="math/tex" id="MathJax-Element-33">\sigma</script></span>来控制平滑的区域：</p>
<div class="math">
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-34-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mtable columnalign=&quot;right left&quot; rowspacing=&quot;3pt&quot; columnspacing=&quot;0em&quot; displaystyle=&quot;true&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;{&lt;/mo&gt;&lt;mtable columnalign=&quot;left left&quot; rowspacing=&quot;.2em&quot; columnspacing=&quot;1em&quot; displaystyle=&quot;false&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;msup&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;/mtd&gt;&lt;mtd&gt;&lt;mtext&gt;if&amp;#xA0;&lt;/mtext&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;&amp;lt;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo stretchy=&quot;false&quot;&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;0.5&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;/mtd&gt;&lt;mtd&gt;&lt;mtext&gt;otherwise&lt;/mtext&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo fence=&quot;true&quot; stretchy=&quot;true&quot; symmetric=&quot;true&quot;&gt;&lt;/mo&gt;&lt;/mrow&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-220" style="width: 18.539em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.815em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(0.59em, 1015.65em, 3.315em, -999.997em); top: -2.188em; left: 0em;"><span class="mrow" id="MathJax-Span-221"><span class="mtable" id="MathJax-Span-222" style="padding-right: 0.163em; padding-left: 0.163em;"><span style="display: inline-block; position: relative; width: 15.494em; height: 0px;"><span style="position: absolute; clip: rect(2.407em, 1015.49em, 5.131em, -999.997em); top: -4.004em; left: 0em;"><span style="display: inline-block; position: relative; width: 15.494em; height: 0px;"><span style="position: absolute; clip: rect(2.407em, 1015.49em, 5.131em, -999.997em); top: -4.004em; right: 0em;"><span class="mtd" id="MathJax-Span-223"><span class="mrow" id="MathJax-Span-224"><span class="mi" id="MathJax-Span-225" style="font-family: MathJax_Math-italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.056em;"></span></span><span class="mo" id="MathJax-Span-226" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-227" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-228" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-229" style="font-family: MathJax_Main; padding-left: 0.27em;">=</span><span class="mrow" id="MathJax-Span-230" style="padding-left: 0.27em;"><span class="mo" id="MathJax-Span-231" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">{</span></span><span class="mtable" id="MathJax-Span-232" style="padding-right: 0.163em; padding-left: 0.163em;"><span style="display: inline-block; position: relative; width: 11.221em; height: 0px;"><span style="position: absolute; clip: rect(2.407em, 1005.4em, 5.077em, -999.997em); top: -4.004em; left: 0em;"><span style="display: inline-block; position: relative; width: 5.451em; height: 0px;"><span style="position: absolute; clip: rect(2.994em, 1003.58em, 4.436em, -999.997em); top: -4.591em; left: 0em;"><span class="mtd" id="MathJax-Span-233"><span class="mrow" id="MathJax-Span-234"><span class="mo" id="MathJax-Span-235" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-236" style="font-family: MathJax_Math-italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mi" id="MathJax-Span-237" style="font-family: MathJax_Math-italic;">x</span><span class="msubsup" id="MathJax-Span-238"><span style="display: inline-block; position: relative; width: 0.804em; height: 0px;"><span style="position: absolute; clip: rect(3.101em, 1000.32em, 4.436em, -999.997em); top: -4.004em; left: 0em;"><span class="mo" id="MathJax-Span-239" style="font-family: MathJax_Main;">)</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -4.378em; left: 0.377em;"><span class="mn" id="MathJax-Span-240" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="texatom" id="MathJax-Span-241"><span class="mrow" id="MathJax-Span-242"><span class="mo" id="MathJax-Span-243" style="font-family: MathJax_Main;">/</span></span></span><span class="mn" id="MathJax-Span-244" style="font-family: MathJax_Main;">2</span><span class="mo" id="MathJax-Span-245" style="font-family: MathJax_Main;">,</span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(2.994em, 1005.4em, 4.436em, -999.997em); top: -3.309em; left: 0em;"><span class="mtd" id="MathJax-Span-258"><span class="mrow" id="MathJax-Span-259"><span class="texatom" id="MathJax-Span-260"><span class="mrow" id="MathJax-Span-261"><span class="mo" id="MathJax-Span-262" style="font-family: MathJax_Main;">|</span></span></span><span class="mi" id="MathJax-Span-263" style="font-family: MathJax_Math-italic;">x</span><span class="texatom" id="MathJax-Span-264"><span class="mrow" id="MathJax-Span-265"><span class="mo" id="MathJax-Span-266" style="font-family: MathJax_Main;">|</span></span></span><span class="mo" id="MathJax-Span-267" style="font-family: MathJax_Main; padding-left: 0.216em;">−</span><span class="mn" id="MathJax-Span-268" style="font-family: MathJax_Main; padding-left: 0.216em;">0.5</span><span class="texatom" id="MathJax-Span-269"><span class="mrow" id="MathJax-Span-270"><span class="mo" id="MathJax-Span-271" style="font-family: MathJax_Main;">/</span></span></span><span class="msubsup" id="MathJax-Span-272"><span style="display: inline-block; position: relative; width: 1.071em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.59em, 4.169em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-273" style="font-family: MathJax_Math-italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -4.378em; left: 0.644em;"><span class="mn" id="MathJax-Span-274" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="mo" id="MathJax-Span-275" style="font-family: MathJax_Main;">,</span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(2.407em, 1004.76em, 4.864em, -999.997em); top: -4.004em; left: 6.466em;"><span style="display: inline-block; position: relative; width: 4.757em; height: 0px;"><span style="position: absolute; clip: rect(2.994em, 1004.76em, 4.436em, -999.997em); top: -4.591em; left: 0em;"><span class="mtd" id="MathJax-Span-246"><span class="mrow" id="MathJax-Span-247"><span class="mtext" id="MathJax-Span-248" style="font-family: MathJax_Main;">if&nbsp;</span><span class="mi" id="MathJax-Span-249" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-250" style="font-family: MathJax_Main; padding-left: 0.27em;">&lt;</span><span class="mn" id="MathJax-Span-251" style="font-family: MathJax_Main; padding-left: 0.27em;">1</span><span class="texatom" id="MathJax-Span-252"><span class="mrow" id="MathJax-Span-253"><span class="mo" id="MathJax-Span-254" style="font-family: MathJax_Main;">/</span></span></span><span class="msubsup" id="MathJax-Span-255"><span style="display: inline-block; position: relative; width: 1.071em; height: 0px;"><span style="position: absolute; clip: rect(3.421em, 1000.59em, 4.169em, -999.997em); top: -4.004em; left: 0em;"><span class="mi" id="MathJax-Span-256" style="font-family: MathJax_Math-italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; top: -4.378em; left: 0.644em;"><span class="mn" id="MathJax-Span-257" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span><span style="position: absolute; clip: rect(3.154em, 1004.12em, 4.169em, -999.997em); top: -3.309em; left: 0em;"><span class="mtd" id="MathJax-Span-276"><span class="mrow" id="MathJax-Span-277"><span class="mtext" id="MathJax-Span-278" style="font-family: MathJax_Main;">otherwise</span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span><span class="mo" id="MathJax-Span-279"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span><span style="display: inline-block; width: 0px; height: 4.009em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.193em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.184em; border-left: 0px solid; width: 0px; height: 2.941em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtable columnalign="right left" rowspacing="3pt" columnspacing="0em" displaystyle="true"><mtr><mtd><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo>{</mo><mtable columnalign="left left" rowspacing=".2em" columnspacing="1em" displaystyle="false"><mtr><mtd><mo stretchy="false">(</mo><mi>σ</mi><mi>x</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mn>2</mn><mo>,</mo></mtd><mtd><mtext>if&nbsp;</mtext><mi>x</mi><mo>&lt;</mo><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msup><mi>σ</mi><mn>2</mn></msup></mtd></mtr><mtr><mtd><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>x</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mo>−</mo><mn>0.5</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>,</mo></mtd><mtd><mtext>otherwise</mtext></mtd></mtr></mtable><mo fence="true" stretchy="true" symmetric="true"></mo></mrow></mtd></mtr></mtable></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-34">\begin{split}f(x) =
    \begin{cases}
    (\sigma x)^2/2,& \text{if }x < 1/\sigma^2\\
    |x|-0.5/\sigma^2,& \text{otherwise}
    \end{cases}\end{split}</script></div>
<p>我们图示不同的<span class="math"><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-35-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-280" style="width: 0.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.59em; height: 0px; font-size: 117%;"><span style="position: absolute; clip: rect(1.659em, 1000.59em, 2.407em, -999.997em); top: -2.241em; left: 0em;"><span class="mrow" id="MathJax-Span-281"><span class="mi" id="MathJax-Span-282" style="font-family: MathJax_Math-italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.246em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.628em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>σ</mi></math></span></span><script type="math/tex" id="MathJax-Element-35">\sigma</script></span>的平滑L1损失和L2损失的区别。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scales</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">smooth_l1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">scales</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">'scale='</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">'Square loss'</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_ssd_41_0.png" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/chapter_computer-vision_ssd_41_0.png">
</div>
</div>
<p>我们同样通过继承<code class="docutils literal"><span class="pre">Loss</span></code>来定义这个损失。同时它接受一个额外参数<code class="docutils literal"><span class="pre">mask</span></code>，这是用来屏蔽掉不需要被惩罚的负例样本。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SmoothL1Loss</span><span class="p">(</span><span class="n">gluon</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">Loss</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SmoothL1Loss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">batch_axis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hybrid_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">smooth_l1</span><span class="p">((</span><span class="n">output</span> <span class="o">-</span> <span class="n">label</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_axis</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">box_loss</span> <span class="o">=</span> <span class="n">SmoothL1Loss</span><span class="p">()</span>
<span class="n">box_loss</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[22]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>SmoothL1Loss(batch_axis=0, w=None)
</pre></div>
</div>
</div>
</div>
<div class="section" id="评估测量">
<h3>评估测量<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AF%84%E4%BC%B0%E6%B5%8B%E9%87%8F" title="永久链接至标题">¶</a></h3>
<p>对于分类好坏我们可以沿用之前的分类精度。评估边框预测的好坏的一个常用是是平均绝对误差。记得在<a class="reference internal" href="http://zh.gluon.ai/chapter_supervised-learning/linear-regression-scratch.html"><span class="doc">线性回归</span></a>我们使用了平均平方误差。但跟上面对损失函数的讨论一样，平方误差对于大的误差给予过大的值，从而数值上过于敏感。平均绝对误差就是将二次项替换成绝对值，具体来说就是预测的边框和真实边框在4个维度上的差值的绝对值。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">metric</span>

<span class="n">cls_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">()</span>
<span class="n">box_metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">MAE</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="初始化模型和训练器">
<h3>初始化模型和训练器<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A8%A1%E5%9E%8B%E5%92%8C%E8%AE%AD%E7%BB%83%E5%99%A8" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">init</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">gpu</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">gpu</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># the CUDA implementation requres each image has at least 3 lables.</span>
<span class="c1"># Padd two -1 labels for each instance</span>
<span class="n">train_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">label_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">sync_label_shape</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="n">net</span> <span class="o">=</span> <span class="n">ToySSD</span><span class="p">(</span><span class="n">num_class</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">init</span><span class="o">.</span><span class="n">Xavier</span><span class="p">(</span><span class="n">magnitude</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">collect_params</span><span class="p">(),</span>
                        <span class="s1">'sgd'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'learning_rate'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">'wd'</span><span class="p">:</span> <span class="mf">5e-4</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="训练模型">
<h3>训练模型<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B" title="永久链接至标题">¶</a></h3>
<p>训练函数跟前面的不一样在于网络会有多个输出，而且有两个损失函数。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">autograd</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="c1"># reset data iterators and metrics</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">cls_metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">box_metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_in_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_in_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">autograd</span><span class="o">.</span><span class="n">record</span><span class="p">():</span>
            <span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">box_preds</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">box_target</span><span class="p">,</span> <span class="n">box_mask</span><span class="p">,</span> <span class="n">cls_target</span> <span class="o">=</span> <span class="n">training_targets</span><span class="p">(</span>
                <span class="n">anchors</span><span class="p">,</span> <span class="n">class_preds</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="c1"># losses</span>
            <span class="n">loss1</span> <span class="o">=</span> <span class="n">cls_loss</span><span class="p">(</span><span class="n">class_preds</span><span class="p">,</span> <span class="n">cls_target</span><span class="p">)</span>
            <span class="n">loss2</span> <span class="o">=</span> <span class="n">box_loss</span><span class="p">(</span><span class="n">box_preds</span><span class="p">,</span> <span class="n">box_target</span><span class="p">,</span> <span class="n">box_mask</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss1</span> <span class="o">+</span> <span class="n">loss2</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="c1"># update metrics</span>
        <span class="n">cls_metric</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">cls_target</span><span class="p">],</span> <span class="p">[</span><span class="n">class_preds</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))])</span>
        <span class="n">box_metric</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">box_target</span><span class="p">],</span> <span class="p">[</span><span class="n">box_preds</span> <span class="o">*</span> <span class="n">box_mask</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">%2d</span><span class="s1">, train </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.2f</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="s1">, time </span><span class="si">%.1f</span><span class="s1"> sec'</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">epoch</span><span class="p">,</span> <span class="o">*</span><span class="n">cls_metric</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">*</span><span class="n">box_metric</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tic</span>
    <span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>Epoch  0, train accuracy 0.95, mae 0.00412, time 12.8 sec
Epoch  1, train accuracy 0.99, mae 0.00366, time 10.6 sec
Epoch  2, train accuracy 0.99, mae 0.00341, time 10.6 sec
Epoch  3, train accuracy 0.99, mae 0.00336, time 10.6 sec
Epoch  4, train accuracy 0.99, mae 0.00325, time 10.6 sec
Epoch  5, train accuracy 0.99, mae 0.00337, time 10.6 sec
Epoch  6, train accuracy 1.00, mae 0.00316, time 10.6 sec
Epoch  7, train accuracy 1.00, mae 0.00318, time 10.6 sec
Epoch  8, train accuracy 1.00, mae 0.00296, time 10.7 sec
Epoch  9, train accuracy 1.00, mae 0.00293, time 10.6 sec
Epoch 10, train accuracy 1.00, mae 0.00289, time 10.6 sec
Epoch 11, train accuracy 1.00, mae 0.00294, time 10.6 sec
Epoch 12, train accuracy 1.00, mae 0.00289, time 10.6 sec
Epoch 13, train accuracy 1.00, mae 0.00290, time 10.7 sec
Epoch 14, train accuracy 1.00, mae 0.00285, time 10.7 sec
Epoch 15, train accuracy 1.00, mae 0.00288, time 11.2 sec
Epoch 16, train accuracy 1.00, mae 0.00278, time 10.7 sec
Epoch 17, train accuracy 1.00, mae 0.00269, time 11.1 sec
Epoch 18, train accuracy 1.00, mae 0.00273, time 11.4 sec
Epoch 19, train accuracy 1.00, mae 0.00266, time 11.4 sec
Epoch 20, train accuracy 1.00, mae 0.00273, time 11.4 sec
Epoch 21, train accuracy 1.00, mae 0.00276, time 11.4 sec
Epoch 22, train accuracy 1.00, mae 0.00286, time 11.5 sec
Epoch 23, train accuracy 1.00, mae 0.00257, time 11.8 sec
Epoch 24, train accuracy 1.00, mae 0.00269, time 11.4 sec
Epoch 25, train accuracy 1.00, mae 0.00262, time 11.5 sec
Epoch 26, train accuracy 1.00, mae 0.00250, time 11.6 sec
Epoch 27, train accuracy 1.00, mae 0.00271, time 11.4 sec
Epoch 28, train accuracy 1.00, mae 0.00264, time 11.4 sec
Epoch 29, train accuracy 1.00, mae 0.00263, time 11.4 sec
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="预测">
<h2>预测<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E9%A2%84%E6%B5%8B" title="永久链接至标题">¶</a></h2>
<p>在预测阶段，我们希望能把图片里面所有感兴趣的物体找出来。</p>
<p>我们先定一个数据读取和预处理函数。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="c1"># resize to data_shape</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imresize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">)</span>
    <span class="c1"># minus rgb mean</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">)</span> <span class="o">-</span> <span class="n">rgb_mean</span>
    <span class="c1"># convert to batch x channel x height xwidth</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">im</span>

</pre></div>
</div>
</div>
<p>然后我们跟训练那样预测表框和其对应的物体。但注意到因为我们对每个像素都会生成数个锚框，这样我们可能会预测出大量相似的表框，从而导致结果非常嘈杂。一个办法是对于IoU比较高的两个表框，我们只保留预测执行度比较高的那个。这个算法（称之为non
maximum
suppression）在<code class="docutils literal"><span class="pre">MultiBoxDetection</span></code>里实现了。下面我们实现预测函数：</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [27]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet.contrib.ndarray</span> <span class="kn">import</span> <span class="n">MultiBoxDetection</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">anchors</span><span class="p">,</span> <span class="n">cls_preds</span><span class="p">,</span> <span class="n">box_preds</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">as_in_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
    <span class="n">cls_probs</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">SoftmaxActivation</span><span class="p">(</span>
        <span class="n">cls_preds</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'channel'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MultiBoxDetection</span><span class="p">(</span><span class="n">cls_probs</span><span class="p">,</span> <span class="n">box_preds</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span>
                             <span class="n">force_suppress</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>预测函数会输出所有边框，每个边框由<code class="docutils literal"><span class="pre">[class_id,</span> <span class="pre">confidence,</span> <span class="pre">xmin,</span> <span class="pre">ymin,</span> <span class="pre">xmax,</span> <span class="pre">ymax]</span></code>表示。其中<code class="docutils literal"><span class="pre">class_id=-1</span></code>表示要么这个边框被预测只含有背景，或者被去重掉了。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">process_image</span><span class="p">(</span><span class="s1">'../img/pikachu.jpg'</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">out</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[28]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre><span></span>(1, 5444, 6)
</pre></div>
</div>
</div>
<p>最后我们将预测出置信度超过某个阈值的边框画出来：</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [29]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">class_id</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">class_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">class_id</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">box_to_rect</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="s1">'{:s} {:.2f}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">score</span><span class="p">),</span>
                       <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'white'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">display</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_ssd_57_0.png" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/chapter_computer-vision_ssd_57_0.png">
</div>
</div>
</div>
<div class="section" id="结论">
<h2>结论<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E7%BB%93%E8%AE%BA" title="永久链接至标题">¶</a></h2>
<p>物体检测比分类要困难很多。因为我们不仅要预测物体类别，还要找到它们的位置。这一章我们展示我们还是可以在合理篇幅里实现SSD算法。</p>
</div>
<div class="section" id="练习">
<h2>练习<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html#%E7%BB%83%E4%B9%A0" title="永久链接至标题">¶</a></h2>
<p>我们有很多细节并没有展开讨论。例如</p>
<ol class="arabic simple">
<li>锚框的大小和长宽比是如何选取的</li>
<li><code class="docutils literal"><span class="pre">MultiBoxTarget</span></code>里我们没有采样负例</li>
<li>分类和回归损失我们直接加起来了，并没有给予权重</li>
<li>在展示的时候如何选取阈值<code class="docutils literal"><span class="pre">threshold</span></code></li>
</ol>
<p><strong>吐槽和讨论欢迎点</strong><a class="reference external" href="https://discuss.gluon.ai/t/topic/2511">这里</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="http://zh.gluon.ai/chapter_computer-vision/yolo.html" class="btn btn-neutral float-right" title="目标检测模型：YOLO" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="http://zh.gluon.ai/chapter_computer-vision/object-detection.html" class="btn btn-neutral" title="目标检测" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr>

  <div role="contentinfo">
    <p>
        © Copyright 2017, Contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.6',
            LANGUAGE:'zh_CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/jquery.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/underscore.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/doctools.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/baidu_tongji.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/google_analytics.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/translations.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/MathJax.js.下载"></script>

  

  
  
    <script type="text/javascript" src="./目标检测模型：SSD — 动手学深度学习 0.6 文档_files/theme.js.下载"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 


<div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size3, sans-serif;"></div></div></body></html>