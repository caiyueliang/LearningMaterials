<!DOCTYPE html>
<!-- saved from url=(0052)http://zh.gluon.ai/chapter_computer-vision/yolo.html -->
<html class=" js flexbox canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths" lang="zh-CN" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>目标检测模型：YOLO — 动手学深度学习 0.6 文档</title>
  

  
  
    <link rel="shortcut icon" href="http://zh.gluon.ai/_static/gluon_s2.png">
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/theme.css" type="text/css">
  <link rel="stylesheet" href="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/pygments.css" type="text/css">
  <link rel="stylesheet" href="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/gluon.css" type="text/css">
    <link rel="index" title="索引" href="http://zh.gluon.ai/genindex.html">
    <link rel="search" title="搜索" href="http://zh.gluon.ai/search.html">
    <link rel="next" title="语义分割" href="http://zh.gluon.ai/chapter_computer-vision/fcn.html">
    <link rel="prev" title="目标检测模型：SSD" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html"> 

  
  <script async="" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/analytics.js.下载"></script><script src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/hm.js.下载"></script><script src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/modernizr.min.js.下载"></script>

<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>

<body class="wy-body-for-nav"><div id="MathJax_Message" style="display: none;"></div>

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="http://zh.gluon.ai/index.html" class="icon icon-home"> 动手学深度学习
          

          
            
            <img src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/gluon_white.png" class="logo" alt="Logo">
          
          </a>

          
            
            
              <div class="version">
                0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="http://zh.gluon.ai/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_preface/index.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_crashcourse/index.html">预备知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_supervised-learning/index.html">深度学习模型基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_gluon-basics/index.html">深度学习计算基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_convolutional-neural-networks/index.html">卷积神经网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_recurrent-neural-networks/index.html">循环神经网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_optimization/index.html">优化算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_gluon-advances/index.html">计算性能</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/index.html"><span class="toctree-expand"></span>计算机视觉</a><ul class="">
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/image-augmentation.html">图片增广</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/fine-tuning.html">迁移学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/object-detection.html">目标检测</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/ssd.html">目标检测模型：SSD</a></li>
<li class="toctree-l2 current"><a class="reference internal current" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#"><span class="toctree-expand"></span>目标检测模型：YOLO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#YOLO-v2"><span class="toctree-expand"></span>YOLO v2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E5%8E%9F%E5%A7%8B%E5%8D%B7%E7%A7%AF%E8%BE%93%E5%87%BA%E7%9A%84%E8%BD%AC%E6%8D%A2">原始卷积输出的转换</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%9D%A5%E7%94%9F%E6%88%90yolo2%E8%AE%AD%E7%BB%83%E7%9B%AE%E6%A0%87">定义一个函数来生成yolo2训练目标</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%88%91%E4%BB%AC%E7%94%A8YOLO2Output%E4%BD%9C%E4%B8%BAyolo2%E7%9A%84%E8%BE%93%E5%87%BA%E5%B1%82%EF%BC%8C%E5%85%B6%E5%AE%9E%E6%9C%AC%E8%B4%A8%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AAHybridBlock%EF%BC%8C%E5%86%85%E9%83%A8%E5%8C%85%E4%BA%86%E4%B8%80%E4%B8%AA%E5%8D%B7%E7%A7%AF%E5%B1%82%E4%BD%9C%E4%B8%BA%E6%9C%80%E7%BB%88%E7%9A%84%E8%BE%93%E5%87%BA">我们用YOLO2Output作为yolo2的输出层，其实本质就是一个HybridBlock，内部包了一个卷积层作为最终的输出</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%98%AF%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E9%9B%86">接下来是下载并加载数据集</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0">损失函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E7%BD%91%E7%BB%9C">网络</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81GPU%E6%9D%A5%E5%8A%A0%E9%80%9F%E8%AE%AD%E7%BB%83">这里我们还是需要GPU来加速训练</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E9%A2%84%E5%A4%84%E7%90%86%E5%92%8C%E9%A2%84%E6%B5%8B%E5%87%BD%E6%95%B0">预处理和预测函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E7%BB%A7%E7%BB%AD%E8%AF%BB%E5%8F%96%E7%9A%AE%E5%8D%A1%E4%B8%98%E6%9D%A5%E5%81%9A%E6%B5%8B%E8%AF%95">继续读取皮卡丘来做测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%98%BE%E7%A4%BA%E7%BB%93%E6%9E%9C">显示结果</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E8%AF%BE%E5%90%8E%E4%B9%A0%E9%A2%98">课后习题</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/fcn.html">语义分割</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/neural-style.html">样式迁移</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/kaggle-gluon-cifar10.html">实战Kaggle比赛：使用Gluon对原始图像文件分类（CIFAR-10）</a></li>
<li class="toctree-l2"><a class="reference internal" href="http://zh.gluon.ai/chapter_computer-vision/kaggle-gluon-dog.html">实战Kaggle比赛：使用Gluon识别120种狗 (ImageNet Dogs)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_natural-language-processing/index.html">自然语言处理</a></li>
<li class="toctree-l1"><a class="reference internal" href="http://zh.gluon.ai/chapter_appendix/index.html">附录</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="http://zh.gluon.ai/index.html">动手学深度学习</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="http://zh.gluon.ai/index.html">Docs</a> »</li>
        
          <li><a href="http://zh.gluon.ai/chapter_computer-vision/index.html">计算机视觉</a> »</li>
        
      <li>目标检测模型：YOLO</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="http://zh.gluon.ai/_sources/chapter_computer-vision/yolo.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="目标检测模型：YOLO">
<h1>目标检测模型：YOLO<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B%EF%BC%9AYOLO" title="永久链接至标题">¶</a></h1>
<p>接着上一讲的SSD，我们继续来实现一个目标检测的经典算法–YOLO2。YOLO2是继YOLO之后使用纯卷积网络的作品。
这里不再赘述数据集之类的琐事，直接进入算法实现的部分，推荐不熟悉的小伙伴先用SSD的例子热身一下。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mxnet</span> <span class="kn">as</span> <span class="nn">mx</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">gluon</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">nd</span>
<span class="kn">from</span> <span class="nn">mxnet.gluon</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mxnet.gluon</span> <span class="kn">import</span> <span class="n">Block</span><span class="p">,</span> <span class="n">HybridBlock</span>
<span class="kn">from</span> <span class="nn">mxnet.gluon.model_zoo</span> <span class="kn">import</span> <span class="n">vision</span>
</pre></div>
</div>
</div>
<div class="section" id="YOLO-v2">
<h2>YOLO v2<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#YOLO-v2" title="永久链接至标题">¶</a></h2>
<div class="section" id="原始卷积输出的转换">
<h3>原始卷积输出的转换<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E5%8E%9F%E5%A7%8B%E5%8D%B7%E7%A7%AF%E8%BE%93%E5%87%BA%E7%9A%84%E8%BD%AC%E6%8D%A2" title="永久链接至标题">¶</a></h3>
<p>我们知道原始卷积输出的是一个 (B, N, H, W)的矩阵，其中B是batch-size，
H和W是特征层的空间维度，N是卷积的输出通道数，相对比较复杂，是我们关注的维度。
简单地说，我们需要对每个空间维度上的点(x, y)输出（类别数 + 1 +
4）个预测值。类别数很好理解，就是训练集里正类的数量，
4也很好理解，就是每个预测框的偏移量预测(x, y, w, h)</p>
<div class="section" id="中心点的转换">
<h4>中心点的转换<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E4%B8%AD%E5%BF%83%E7%82%B9%E7%9A%84%E8%BD%AC%E6%8D%A2" title="永久链接至标题">¶</a></h4>
<p>中心点是sigmoid函数的输出值，本身在0到1之间，表示的意义是每个格点内部的空间位置，我们需要把它们转换成图片上的相对位置。
通过arange函数生成连续递增的数列，加上预测值，就是每个目标中心在图片上的相对坐标。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">transform_center</span><span class="p">(</span><span class="n">xy</span><span class="p">):</span>
    <span class="sd">"""Given x, y prediction after sigmoid(), convert to relative coordinates (0, 1) on image."""</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">offset_y</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">xy</span><span class="o">.</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># print(offset_y[0].asnumpy()[:, :, 0, 0])</span>
    <span class="n">offset_x</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">xy</span><span class="o">.</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># print(offset_x[0].asnumpy()[:, :, 0, 0])</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">offset_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">offset_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="长宽的转换">
<h4>长宽的转换<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E9%95%BF%E5%AE%BD%E7%9A%84%E8%BD%AC%E6%8D%A2" title="永久链接至标题">¶</a></h4>
<p>长宽是exp函数的输出，意义是相对于锚点长宽的比率，我们对预测值的exp()乘以相对锚点的长宽，除以图片格点的数量，得到的是目标长宽相对于图片的尺寸。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">transform_size</span><span class="p">(</span><span class="n">wh</span><span class="p">,</span> <span class="n">anchors</span><span class="p">):</span>
    <span class="sd">"""Given w, h prediction after exp() and anchor sizes, convert to relative width/height (0, 1) on image"""</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">wh</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">aw</span><span class="p">,</span> <span class="n">ah</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">wh</span><span class="o">.</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w_pred</span><span class="p">,</span> <span class="n">h_pred</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">wh</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">num_outputs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w_out</span> <span class="o">=</span> <span class="n">w_pred</span> <span class="o">*</span> <span class="n">aw</span> <span class="o">/</span> <span class="n">w</span>
    <span class="n">h_out</span> <span class="o">=</span> <span class="n">h_pred</span> <span class="o">*</span> <span class="n">ah</span> <span class="o">/</span> <span class="n">h</span>
    <span class="k">return</span> <span class="n">w_out</span><span class="p">,</span> <span class="n">h_out</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="yolo2_forward作为一个方便使用的函数，会把卷积的通道分开，转换，最后转成我们需要的检测框">
<h4>yolo2_forward作为一个方便使用的函数，会把卷积的通道分开，转换，最后转成我们需要的检测框<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#yolo2_forward%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA%E6%96%B9%E4%BE%BF%E4%BD%BF%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BC%9A%E6%8A%8A%E5%8D%B7%E7%A7%AF%E7%9A%84%E9%80%9A%E9%81%93%E5%88%86%E5%BC%80%EF%BC%8C%E8%BD%AC%E6%8D%A2%EF%BC%8C%E6%9C%80%E5%90%8E%E8%BD%AC%E6%88%90%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E7%9A%84%E6%A3%80%E6%B5%8B%E6%A1%86" title="永久链接至标题">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">yolo2_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_class</span><span class="p">,</span> <span class="n">anchor_scales</span><span class="p">):</span>
    <span class="sd">"""Transpose/reshape/organize convolution outputs."""</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="n">num_class</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="c1"># transpose and reshape, 4th dim is the number of anchors</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="p">))</span>
    <span class="c1"># now x is (batch, m, n, stride), stride = num_class + 1(object score) + 4(coordinates)</span>
    <span class="c1"># class probs</span>
    <span class="n">cls_pred</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">num_class</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># object score</span>
    <span class="n">score_pred</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="n">num_class</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">num_class</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">score_pred</span><span class="p">)</span>
    <span class="c1"># center prediction, in range(0, 1) for each grid</span>
    <span class="n">xy_pred</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="n">num_class</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">num_class</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">xy_pred</span><span class="p">)</span>
    <span class="c1"># width/height prediction</span>
    <span class="n">wh</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="n">num_class</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">num_class</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># convert x, y to positions relative to image</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transform_center</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
    <span class="c1"># convert w, h to width/height relative to image</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">transform_size</span><span class="p">(</span><span class="n">wh</span><span class="p">,</span> <span class="n">anchor_scales</span><span class="p">)</span>
    <span class="c1"># cid is the argmax channel</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cls_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># convert to corner format boxes</span>
    <span class="n">half_w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">half_h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">half_w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">half_h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">half_w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">half_h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">cid</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">cls_pred</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">nd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">xy</span><span class="p">,</span> <span class="n">wh</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="定义一个函数来生成yolo2训练目标">
<h3>定义一个函数来生成yolo2训练目标<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%9D%A5%E7%94%9F%E6%88%90yolo2%E8%AE%AD%E7%BB%83%E7%9B%AE%E6%A0%87" title="永久链接至标题">¶</a></h3>
<p>YOLO2寻找真实目标的方法比较特殊，是在每个格点内各自比较，而不是使用全局的预设。而且我们不需要对生成的训练目标进行反向传播，为了简洁描述比较的方法，我们可以在这里转成numpy而且可以用for循环（切记转成numpy会破坏自动求导的记录，只有当反向传播不需要的时候才能使用这个技巧），实际使用中，如果遇到速度问题，我们可以用mx.ndarray矩阵的写法来加速。
这里我们使用了一个技巧：sample_weight（个体权重）矩阵，
用于损失函数内部权重的调整，我们也可以通过权重矩阵来控制哪些个体需要被屏蔽，这一点在目标检测中尤其重要，因为往往大多数的背景区域不需要预测检测框。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">corner2center</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">concat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">"""Convert left/top/right/bottom style boxes into x/y/w/h format"""</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span>
    <span class="k">if</span> <span class="n">concat</span><span class="p">:</span>
        <span class="n">last_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">nd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">last_dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>

<span class="k">def</span> <span class="nf">center2corner</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">concat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">"""Convert x/y/w/h style boxes into left/top/right/bottom format"""</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_outputs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">w2</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">h2</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w2</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h2</span>
    <span class="k">if</span> <span class="n">concat</span><span class="p">:</span>
        <span class="n">last_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">nd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">last_dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span>

<span class="k">def</span> <span class="nf">yolo2_target</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">ignore_label</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">"""Generate training targets given predictions and labels."""</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">anchors</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1">#scores = nd.slice_axis(outputs, begin=1, end=2, axis=-1)</span>
    <span class="c1">#boxes = nd.slice_axis(outputs, begin=2, end=6, axis=-1)</span>
    <span class="n">gt_boxes</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">target_score</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="n">target_id</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">target_score</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">*</span> <span class="n">ignore_label</span>
    <span class="n">target_box</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ctx</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># find the best match for each ground-truth</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">valid_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
        <span class="c1"># shuffle because multi gt could possibly match to one anchor, we keep the last match randomly</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">valid_label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">valid_label</span><span class="p">:</span>
            <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">gw</span><span class="p">,</span> <span class="n">gh</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ind_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gx</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
            <span class="n">ind_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gy</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">w</span> <span class="o">-</span> <span class="n">ind_x</span>
            <span class="n">ty</span> <span class="o">=</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">h</span> <span class="o">-</span> <span class="n">ind_y</span>
            <span class="n">gw</span> <span class="o">=</span> <span class="n">gw</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">gh</span> <span class="o">=</span> <span class="n">gh</span> <span class="o">*</span> <span class="n">h</span>
            <span class="c1"># find the best match using width and height only, assuming centers are identical</span>
            <span class="n">intersect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">anchors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">gw</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">anchors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gh</span><span class="p">)</span>
            <span class="n">ovps</span> <span class="o">=</span> <span class="n">intersect</span> <span class="o">/</span> <span class="p">(</span><span class="n">gw</span> <span class="o">*</span> <span class="n">gh</span> <span class="o">+</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">anchors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">intersect</span><span class="p">)</span>
            <span class="n">best_match</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ovps</span><span class="p">))</span>
            <span class="n">target_id</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ind_y</span><span class="p">,</span> <span class="n">ind_x</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">target_score</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ind_y</span><span class="p">,</span> <span class="n">ind_x</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gw</span> <span class="o">/</span> <span class="n">anchors</span><span class="p">[</span><span class="n">best_match</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gh</span> <span class="o">/</span> <span class="n">anchors</span><span class="p">[</span><span class="n">best_match</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">target_box</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ind_y</span><span class="p">,</span> <span class="n">ind_x</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">])</span>
            <span class="n">sample_weight</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ind_y</span><span class="p">,</span> <span class="n">ind_x</span><span class="p">,</span> <span class="n">best_match</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="c1"># print('ind_y', ind_y, 'ind_x', ind_x, 'best_match', best_match, 't', tx, ty, tw, th, 'ovp', ovps[best_match], 'gt', gx, gy, gw/w, gh/h, 'anchor', anchors[best_match, 0], anchors[best_match, 1])</span>
    <span class="k">return</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">target_score</span><span class="p">,</span> <span class="n">target_box</span><span class="p">,</span> <span class="n">sample_weight</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="我们用YOLO2Output作为yolo2的输出层，其实本质就是一个HybridBlock，内部包了一个卷积层作为最终的输出">
<h3>我们用YOLO2Output作为yolo2的输出层，其实本质就是一个HybridBlock，内部包了一个卷积层作为最终的输出<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%88%91%E4%BB%AC%E7%94%A8YOLO2Output%E4%BD%9C%E4%B8%BAyolo2%E7%9A%84%E8%BE%93%E5%87%BA%E5%B1%82%EF%BC%8C%E5%85%B6%E5%AE%9E%E6%9C%AC%E8%B4%A8%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AAHybridBlock%EF%BC%8C%E5%86%85%E9%83%A8%E5%8C%85%E4%BA%86%E4%B8%80%E4%B8%AA%E5%8D%B7%E7%A7%AF%E5%B1%82%E4%BD%9C%E4%B8%BA%E6%9C%80%E7%BB%88%E7%9A%84%E8%BE%93%E5%87%BA" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YOLO2Output</span><span class="p">(</span><span class="n">HybridBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_class</span><span class="p">,</span> <span class="n">anchor_scales</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">YOLO2Output</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">num_class</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"number of classes should &gt; 0, given {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_class</span> <span class="o">=</span> <span class="n">num_class</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anchor_scales</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="s2">"list or tuple of anchor scales required"</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchor_scales</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"at least one anchor scale required"</span>
        <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_scales</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"expected each anchor scale to be (width, height), provided {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anchor_scales</span> <span class="o">=</span> <span class="n">anchor_scales</span>
        <span class="n">out_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchor_scales</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_class</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_scope</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">out_channels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hybrid_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="接下来是下载并加载数据集">
<h3>接下来是下载并加载数据集<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%98%AF%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E9%9B%86" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">gluon</span>

<span class="n">root_url</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'https://apache-mxnet.s3-accelerate.amazonaws.com/'</span>
            <span class="s1">'gluon/dataset/pikachu/'</span><span class="p">)</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">'../data/pikachu/'</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train.rec'</span><span class="p">:</span> <span class="s1">'e6bcb6ffba1ac04ff8a9b1115e650af56ee969c8'</span><span class="p">,</span>
          <span class="s1">'train.idx'</span><span class="p">:</span> <span class="s1">'dcf7318b2602c06428b9988470c731621716c393'</span><span class="p">,</span>
          <span class="s1">'val.rec'</span><span class="p">:</span> <span class="s1">'d6c33f799b4d058e82f2cb5bd9a976f69d72d520'</span><span class="p">}</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">root_url</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">+</span><span class="n">k</span><span class="p">,</span> <span class="n">sha1_hash</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">image</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">nd</span>

<span class="n">data_shape</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">rgb_mean</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">104</span><span class="p">])</span>
<span class="n">rgb_std</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">58.395</span><span class="p">,</span> <span class="mf">57.12</span><span class="p">,</span> <span class="mf">57.375</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_iterators</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'pikachu'</span><span class="p">,</span> <span class="s1">'dummy'</span><span class="p">]</span>
    <span class="n">num_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">)</span>
    <span class="n">train_iter</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ImageDetIter</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">data_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">),</span>
        <span class="n">path_imgrec</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">'train.rec'</span><span class="p">,</span>
        <span class="n">path_imgidx</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">'train.idx'</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">mean</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">std</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">rand_crop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">min_object_covered</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="n">max_attempts</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">val_iter</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ImageDetIter</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">data_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">),</span>
        <span class="n">path_imgrec</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">'val.rec'</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">mean</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">std</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_iter</span><span class="p">,</span> <span class="n">val_iter</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">num_class</span>

<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">num_class</span> <span class="o">=</span> <span class="n">get_iterators</span><span class="p">(</span>
    <span class="n">data_shape</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>DataBatch: data shapes: [(32, 3, 256, 256)] label shapes: [(32, 1, 5)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.dpi'</span><span class="p">]</span><span class="o">=</span> <span class="mi">120</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">box_to_rect</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">"""convert an anchor box to a matplotlib rectangle"""</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
        <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">figs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">],</span> <span class="n">batch</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="n">rgb_std</span> <span class="o">+</span> <span class="n">rgb_mean</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span><span class="o">/</span><span class="mi">255</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">box_to_rect</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">data_shape</span><span class="p">,</span><span class="s1">'red'</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_yolo_16_0.png" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/chapter_computer-vision_yolo_16_0.png">
</div>
</div>
</div>
<div class="section" id="损失函数">
<h3>损失函数<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">sce_loss</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">SoftmaxCrossEntropyLoss</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">l1_loss</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="评估测量">
<h4>评估测量<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E8%AF%84%E4%BC%B0%E6%B5%8B%E9%87%8F" title="永久链接至标题">¶</a></h4>
<p>这里我们取巧用一个自己定义的metric来记录纯损失值，有的时候当你想不出特别贴切的观测函数，不如直接看损失值有没有下降</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">metric</span>

<span class="k">class</span> <span class="nc">LossRecorder</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">EvalMetric</span><span class="p">):</span>
    <span class="sd">"""LossRecorder is used to record raw loss so we can observe loss directly</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LossRecorder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">"""Update metric with pure loss</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">mx</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">NDArray</span><span class="p">):</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sum_metric</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_inst</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">obj_loss</span> <span class="o">=</span> <span class="n">LossRecorder</span><span class="p">(</span><span class="s1">'objectness_loss'</span><span class="p">)</span>
<span class="n">cls_loss</span> <span class="o">=</span> <span class="n">LossRecorder</span><span class="p">(</span><span class="s1">'classification_loss'</span><span class="p">)</span>
<span class="n">box_loss</span> <span class="o">=</span> <span class="n">LossRecorder</span><span class="p">(</span><span class="s1">'box_refine_loss'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="粗粒度调控下每种损失相对的权重">
<h4>粗粒度调控下每种损失相对的权重<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E7%B2%97%E7%B2%92%E5%BA%A6%E8%B0%83%E6%8E%A7%E4%B8%8B%E6%AF%8F%E7%A7%8D%E6%8D%9F%E5%A4%B1%E7%9B%B8%E5%AF%B9%E7%9A%84%E6%9D%83%E9%87%8D" title="永久链接至标题">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">positive_weight</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">negative_weight</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">class_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">box_weight</span> <span class="o">=</span> <span class="mf">5.0</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="网络">
<h3>网络<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E7%BD%91%E7%BB%9C" title="永久链接至标题">¶</a></h3>
<p>加载模型园里训练好的resnet网络，取出中间的特征提取层，用合适的锚点尺寸新建我们的YOLO2输出层</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">pretrained</span> <span class="o">=</span> <span class="n">vision</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="s1">'resnet18_v1'</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">features</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pretrained</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">net</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pretrained</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># anchor scales, try adjust it yourself</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">3.3004</span><span class="p">,</span> <span class="mf">3.59034</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">9.84923</span><span class="p">,</span> <span class="mf">8.23783</span><span class="p">]]</span>

<span class="c1"># use 2 classes, 1 as dummy class, otherwise softmax won't work</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">YOLO2Output</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">scales</span><span class="p">)</span>
<span class="n">predictor</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="n">net</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">predictor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="这里我们还是需要GPU来加速训练">
<h3>这里我们还是需要GPU来加速训练<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81GPU%E6%9D%A5%E5%8A%A0%E9%80%9F%E8%AE%AD%E7%BB%83" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">init</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">gpu</span>

<span class="n">ctx</span> <span class="o">=</span> <span class="n">gpu</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">collect_params</span><span class="p">()</span><span class="o">.</span><span class="n">reset_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">collect_params</span><span class="p">(),</span>
                        <span class="s1">'sgd'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'learning_rate'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'wd'</span><span class="p">:</span> <span class="mf">5e-4</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">autograd</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="c1"># reset data iterators and metrics</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">cls_loss</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">obj_loss</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">box_loss</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_in_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_in_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">autograd</span><span class="o">.</span><span class="n">record</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">cls_pred</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">xywh</span> <span class="o">=</span> <span class="n">yolo2_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">scales</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">autograd</span><span class="o">.</span><span class="n">pause</span><span class="p">():</span>
                <span class="n">tid</span><span class="p">,</span> <span class="n">tscore</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">yolo2_target</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">xywh</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="c1"># losses</span>
            <span class="n">loss1</span> <span class="o">=</span> <span class="n">sce_loss</span><span class="p">(</span><span class="n">cls_pred</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">sample_weight</span> <span class="o">*</span> <span class="n">class_weight</span><span class="p">)</span>
            <span class="n">score_weight</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sample_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">nd</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">positive_weight</span><span class="p">,</span>
                                    <span class="n">nd</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">negative_weight</span><span class="p">)</span>
            <span class="n">loss2</span> <span class="o">=</span> <span class="n">l1_loss</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">tscore</span><span class="p">,</span> <span class="n">score_weight</span><span class="p">)</span>
            <span class="n">loss3</span> <span class="o">=</span> <span class="n">l1_loss</span><span class="p">(</span><span class="n">xywh</span><span class="p">,</span> <span class="n">tbox</span><span class="p">,</span> <span class="n">sample_weight</span> <span class="o">*</span> <span class="n">box_weight</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss1</span> <span class="o">+</span> <span class="n">loss2</span> <span class="o">+</span> <span class="n">loss3</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="c1"># update metrics</span>
        <span class="n">cls_loss</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss1</span><span class="p">)</span>
        <span class="n">obj_loss</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss2</span><span class="p">)</span>
        <span class="n">box_loss</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss3</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">%2d</span><span class="s1">, train </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="s1"> time </span><span class="si">%.1f</span><span class="s1"> sec'</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">epoch</span><span class="p">,</span> <span class="o">*</span><span class="n">cls_loss</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">*</span><span class="n">obj_loss</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">*</span><span class="n">box_loss</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tic</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>Epoch  0, train classification_loss 0.00098, objectness_loss 0.03685, box_refine_loss 0.00252 time 9.3 sec
Epoch  1, train classification_loss 0.00038, objectness_loss 0.01635, box_refine_loss 0.00208 time 8.7 sec
Epoch  2, train classification_loss 0.00010, objectness_loss 0.00726, box_refine_loss 0.00190 time 8.4 sec
Epoch  3, train classification_loss 0.00007, objectness_loss 0.00460, box_refine_loss 0.00195 time 8.4 sec
Epoch  4, train classification_loss 0.00006, objectness_loss 0.00346, box_refine_loss 0.00199 time 8.4 sec
Epoch  5, train classification_loss 0.00005, objectness_loss 0.00287, box_refine_loss 0.00192 time 8.3 sec
Epoch  6, train classification_loss 0.00005, objectness_loss 0.00248, box_refine_loss 0.00189 time 8.3 sec
Epoch  7, train classification_loss 0.00004, objectness_loss 0.00219, box_refine_loss 0.00180 time 8.3 sec
Epoch  8, train classification_loss 0.00004, objectness_loss 0.00203, box_refine_loss 0.00174 time 8.4 sec
Epoch  9, train classification_loss 0.00004, objectness_loss 0.00189, box_refine_loss 0.00163 time 8.4 sec
Epoch 10, train classification_loss 0.00004, objectness_loss 0.00183, box_refine_loss 0.00163 time 8.3 sec
Epoch 11, train classification_loss 0.00004, objectness_loss 0.00173, box_refine_loss 0.00159 time 8.3 sec
Epoch 12, train classification_loss 0.00004, objectness_loss 0.00170, box_refine_loss 0.00146 time 8.3 sec
Epoch 13, train classification_loss 0.00004, objectness_loss 0.00163, box_refine_loss 0.00151 time 8.6 sec
Epoch 14, train classification_loss 0.00004, objectness_loss 0.00160, box_refine_loss 0.00141 time 8.4 sec
Epoch 15, train classification_loss 0.00003, objectness_loss 0.00149, box_refine_loss 0.00139 time 8.3 sec
Epoch 16, train classification_loss 0.00003, objectness_loss 0.00145, box_refine_loss 0.00142 time 8.3 sec
Epoch 17, train classification_loss 0.00004, objectness_loss 0.00146, box_refine_loss 0.00133 time 8.3 sec
Epoch 18, train classification_loss 0.00005, objectness_loss 0.00156, box_refine_loss 0.00123 time 8.3 sec
Epoch 19, train classification_loss 0.00003, objectness_loss 0.00134, box_refine_loss 0.00122 time 8.3 sec
</pre></div></div>
</div>
</div>
<div class="section" id="预处理和预测函数">
<h3>预处理和预测函数<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E9%A2%84%E5%A4%84%E7%90%86%E5%92%8C%E9%A2%84%E6%B5%8B%E5%87%BD%E6%95%B0" title="永久链接至标题">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imdecode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="c1"># resize to data_shape</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imresize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">)</span>
    <span class="c1"># minus rgb mean, divide std</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">)</span> <span class="o">-</span> <span class="n">rgb_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">rgb_std</span>
    <span class="c1"># convert to batch x channel x height xwidth</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">im</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">cls_prob</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">xywh</span> <span class="o">=</span> <span class="n">yolo2_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">scales</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nd</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">box_nms</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="继续读取皮卡丘来做测试">
<h3>继续读取皮卡丘来做测试<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E7%BB%A7%E7%BB%AD%E8%AF%BB%E5%8F%96%E7%9A%AE%E5%8D%A1%E4%B8%98%E6%9D%A5%E5%81%9A%E6%B5%8B%E8%AF%95" title="永久链接至标题">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">process_image</span><span class="p">(</span><span class="s1">'../img/pikachu.jpg'</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">as_in_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
<span class="n">out</span><span class="o">.</span><span class="n">shape</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>Out[18]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>[[[ 0.          0.99538165  0.5187977   0.51924545  0.66963738  0.68262941]
  [ 0.          0.98547542  0.22369179  0.6018104   0.35311857  0.72210068]
  [ 0.          0.96096921  0.76051992  0.52929634  0.89430088  0.690162  ]
  ...,
  [-1.         -1.         -1.         -1.         -1.         -1.        ]
  [-1.         -1.         -1.         -1.         -1.         -1.        ]
  [-1.         -1.         -1.         -1.         -1.         -1.        ]]]
&lt;NDArray 1x512x6 @gpu(0)&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="显示结果">
<h3>显示结果<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E6%98%BE%E7%A4%BA%E7%BB%93%E6%9E%9C" title="永久链接至标题">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre><span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-python"><div class="highlight"><pre><span></span><span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'blue'</span><span class="p">,</span> <span class="s1">'green'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'magenta'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
        <span class="n">class_id</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">class_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">class_id</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">box_to_rect</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="s1">'{:s} {:.2f}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">score</span><span class="p">),</span>
                       <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'white'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">display</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/chapter_computer-vision_yolo_33_0.png" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/chapter_computer-vision_yolo_33_0.png">
</div>
</div>
</div>
</div>
<div class="section" id="课后习题">
<h2>课后习题<a class="headerlink" href="http://zh.gluon.ai/chapter_computer-vision/yolo.html#%E8%AF%BE%E5%90%8E%E4%B9%A0%E9%A2%98" title="永久链接至标题">¶</a></h2>
<ol class="arabic simple">
<li>试试改变默认的anchor scale，调整尺寸，增加或减少数量？</li>
<li>调整不同损失函数相对的权重，看看对于训练结果有什么影响？</li>
<li>在目标检测这种batch内部有效目标占比很少的情况下，损失函数内部取平均有什么问题，更好的方法？</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="http://zh.gluon.ai/chapter_computer-vision/fcn.html" class="btn btn-neutral float-right" title="语义分割" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="http://zh.gluon.ai/chapter_computer-vision/ssd.html" class="btn btn-neutral" title="目标检测模型：SSD" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr>

  <div role="contentinfo">
    <p>
        © Copyright 2017, Contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.6',
            LANGUAGE:'zh_CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/jquery.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/underscore.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/doctools.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/baidu_tongji.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/google_analytics.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/translations.js.下载"></script>
      <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/MathJax.js.下载"></script>

  

  
  
    <script type="text/javascript" src="./目标检测模型：YOLO — 动手学深度学习 0.6 文档_files/theme.js.下载"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 


</body></html>